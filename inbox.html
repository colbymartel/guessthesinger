<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Direct Messages | Guessing Games</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
  <style>
html, body {
      margin: 0;
      padding: 0;
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(to bottom, #ffffff, #e7f1f9);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    nav {
      background-color: #1e2b38;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    .nav-links a {
      color: white;
      margin: 0 15px;
      text-decoration: none;
      font-weight: bold;
    }
    .nav-links a:hover {
      color: #ffcb05;
    }

    main {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px);
    }

    .sidebar {
      background-color: #1e2b38;
      color: white;
      padding: 20px;
      overflow-y: auto;
    }

    .chat-container {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      display: none;
    }

    .chat-header {
      font-size: 1.4em;
      margin-bottom: 10px;
    }

    .message {
      background: #e0f0ff;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .message.sent {
      background-color: #d3d3d3;
      align-self: flex-end;
    }

    .message.received {
      background-color: #e0f0ff;
      align-self: flex-start;
    }

    .chat-input {
      display: flex;
      gap: 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .chat-input button {
      padding: 10px 20px;
      background-color: #315f85;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .header {
      background: linear-gradient(135deg, #3b7bbf, #234d7d);
      padding: 30px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      color: white;
    }

    .header .logo img {
      width: 160px;
    }
    .mobile-menu {
  display: none;
  flex-direction: column;
  position: absolute;
  right: 15px;
  top: 120px; /* adjust if needed to push below hamburger */
  background-color: #1e2b38;
  padding: 10px 20px;
  border-radius: 10px;
  z-index: 1000;
  width: max-content;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}
.hamburger {
  display: block;
  font-size: 24px;
  cursor: pointer;
}
.mobile-menu a {
  color: white;
  text-decoration: none;
  padding: 10px 0;
  font-weight: bold;
  width: 100%;
}

.mobile-menu a:hover {
  color: #ffcb05;
}

.mobile-menu.show {
  display: flex;
}

/* Nav adjustments */
@media (max-width: 768px) {
  .nav-links {
    display: none;
  }

  .hamburger {
    display: block;
    color: white;
  }

  nav {
    justify-content: space-between;
  }

  .welcome-nav {
    display: block;
  }
}


    .user-block {
      padding: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #2f3e4f;
    }

    .user-block:hover {
      background-color: #2f3e4f;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .user-name {
      font-weight: bold;
    }

    .unread-icon {
      color: #ffcb05;
      font-size: 16px;
      margin-left: 8px;
    }

    @media (max-width: 768px) {
      .sidebar {
        padding: 10px;
        font-size: 0.9em;
      }

      .chat-container {
        padding: 10px;
      }

      .chat-input input,
      .chat-input button {
        padding: 8px;
      }

      .header .logo img {
        width: 140px;
      }
    }
    .dm-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.dm-tabs .tab {
  padding: 8px 12px;
  border: none;
  border-radius: 20px;
  background: #ddd;
  cursor: pointer;
  font-weight: bold;
}

.dm-tabs .tab.active {
  background: #ffcb05;
}

.search-bar {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
}

.search-bar input {
  flex: 1;
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.search-bar .filter-btn {
  margin-left: 10px;
  padding: 6px 12px;
  border: none;
  background: #315f85;
  color: white;
  border-radius: 8px;
}

.avatar-strip {
  display: flex;
  overflow-x: auto;
  padding: 10px 0;
  gap: 12px;
}

.avatar-bubble {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 12px;
}

.avatar-bubble img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 2px solid #ffcb05;
  object-fit: cover;
}
#messages {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 15px;
  overflow-y: auto;
  height: 100%;
  background-color: #f8f9fc;
  border-radius: 8px;
}

.message {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 20px;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
  position: relative;
  transition: all 0.2s ease;
}

.message.sent {
  align-self: flex-end;
  background-color: #d2e3fc;
  border-bottom-right-radius: 4px;
}

.message.received {
  align-self: flex-start;
  background-color: #ffffff;
  border-bottom-left-radius: 4px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.sender {
  font-size: 11px;
  color: #777;
  margin-bottom: 4px;
}
#messages {
  scroll-behavior: smooth;
}
.chat-input {
  border-top: 1px solid #ccc;
  background-color: #fff;
  padding: 12px;
}
.chat-input input {
  border-radius: 20px;
}
.back-btn {
  background: none;
  border: none;
  color: #315f85;
  font-weight: bold;
  font-size: 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
  padding: 6px 10px;
  border-radius: 8px;
  transition: background 0.2s ease;
}

.back-btn:hover {
  background-color: #e0ecf7;
}

  </style>

  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner" style="display: flex; justify-content: center; align-items: center;">
      <a href="/index.html">
        <img src="images/SingerLogo.png" alt="Guess the Singer Logo" loading="lazy" style="height: 50px;">
      </a>
    </div>
  </header>
  
  <nav>
    <div class="nav-left">
    </div>
    <div class="hamburger" id="hamburger" style="margin-left: auto; cursor:pointer;">
      <i class="fas fa-bars"></i>
    </div>
  </nav>
  

<div id="mobileMenu" class="mobile-menu hidden">
  <a href="/index.html">Home</a>
  <a href="/memory.html">Back to Game</a>
  <a href="/memory-leaderboard.html">Leaderboard</a>
  <a href="/profile.html">My Profile</a>
  <a href="/about.html">About</a>

</div>
  <main style="width: 100%; height: calc(100vh - 100px);">
    <div id="messageListView" style="width: 100%; height: 100%;">
     
      
      <div class="sidebar">
     
        <div class="dm-tabs">
          <button class="tab active" onclick="switchTab('primary')">Primary</button>
          <button class="tab" onclick="switchTab('general')">General</button>
          <button class="tab" onclick="switchTab('requests')">Requests</button>
        </div>
        <div id="userList"></div>
      </div>
      
    </div>
  
    <!-- Full-screen conversation -->
    <div class="chat-container" id="chatContainer" style="display: none;">
      <button class="back-btn" onclick="goBackToUserList()">← Back to Messages</button>
      <div class="chat-header" id="chatHeader">Select a conversation</div>
      <div id="messages"></div>
      <div class="chat-input" style="display:none;" id="chatInputContainer">
        <input type="text" id="messageInput" placeholder="Type your reply...">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </main>
  
  
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
import {
  getFirestore,
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  addDoc,
  serverTimestamp,
  doc,
  getDoc
} from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';

  const firebaseConfig = {
    apiKey: "AIzaSyD36qSJ8YAPc3A4FL9jlBGlpiWwj530SPQ",
    authDomain: "guessthesinger10.firebaseapp.com",
    projectId: "guessthesinger10",
    storageBucket: "guessthesinger10.appspot.com",
    messagingSenderId: "97201023235",
    appId: "1:97201023235:web:ab111d9acb43ef7d4be136"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  let currentUser = null;
  let activeSenderId = null;
  let selectedRecipientId = null;

  const userListEl = document.getElementById("userList");
  const messagesEl = document.getElementById("messages");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatHeader = document.getElementById("chatHeader");
  const chatInputContainer = document.getElementById("chatInputContainer");

  const userMap = new Map();
  function loadInbox() {
  const messagesRef = collection(db, "messages");
  const q = query(messagesRef, orderBy("timestamp"));

  onSnapshot(q, snapshot => {
    const addedUserIds = new Set();
    userListEl.innerHTML = "";

    snapshot.forEach(docSnap => {
      const msg = docSnap.data();

      if (!currentUser) return;
      if (msg.senderId !== currentUser.uid && msg.recipientId !== currentUser.uid) return;

      const otherUserId = msg.senderId === currentUser.uid ? msg.recipientId : msg.senderId;
      if (addedUserIds.has(otherUserId)) return;
      addedUserIds.add(otherUserId);

      const userDocRef = doc(db, "users", otherUserId);
      getDoc(userDocRef).then(userDocSnap => {
        let username = "Unknown User";
        let isVerified = false;
        

        if (userDocSnap.exists()) {
          const userData = userDocSnap.data();
          username = userData.username || username;
          isVerified = userData.isVerified === true;
        }

        getDoc(userDocRef).then(userDocSnap => {
  let username = "Unknown User";
  let isVerified = false;
  let userData = {}; // ✅ declare upfront

  if (userDocSnap.exists()) {
    userData = userDocSnap.data(); // ✅ assign safely
    username = userData.username || username;
    isVerified = userData.isVerified === true;
  }

  getDoc(doc(db, "users", currentUser.uid, "chatStatus", otherUserId)).then(statusSnap => {
    const lastOpened = statusSnap.exists() ? statusSnap.data().lastOpened?.toMillis() : 0;
    const isUnread = !lastOpened || msg.timestamp?.toMillis() > lastOpened;

    const avatarUrl = userData.avatar || "/images/avatars/popstarpenguin.jpg"; 

    const userEl = document.createElement("div");
    userEl.classList.add("user-block");
    if (isUnread) userEl.classList.add("unread");

    userEl.innerHTML = `
      <img class="user-avatar" src="${avatarUrl}" alt="${username}'s avatar" />
      <div class="user-name" style="font-weight:${isUnread ? 'bold' : 'normal'};">
        ${username}${isVerified ? " ✅" : ""} ${isUnread ? '<span class="unread-icon">⚪️</span>' : ''}
      </div>
    `;

    userEl.onclick = () => openChat(otherUserId, username);
    userListEl.appendChild(userEl);
  });
});

      });
    });
  });
}

  onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    loadInbox();

    const recipientId = localStorage.getItem("chatWithUid");
const recipientName = localStorage.getItem("chatWithName");

if (recipientId) {
  startNewChat(recipientId, recipientName || "Unknown User");
}

  } else {
    alert("You must be logged in.");
  }
});



  async function startNewChat(recipientId, fallbackEmail) {
  selectedRecipientId = recipientId;
  activeSenderId = recipientId;

  chatInputContainer.style.display = "flex";
  document.getElementById("chatContainer").style.display = "flex";
  document.getElementById("messageListView").style.display = "none";

  try {
    const userDocRef = doc(db, "users", recipientId);
    const userDocSnap = await getDoc(userDocRef);

    let displayName = "Unknown User";
let isVerified = false;

if (userDocSnap.exists()) {
  const userData = userDocSnap.data();
  displayName = userData.username || "Unknown User";
  isVerified = userData.isVerified === true;
}

chatHeader.textContent = `Chat with ${displayName}${isVerified ? " ✅" : ""}`;

  } catch (err) {
    console.error("Error fetching user profile:", err);
    chatHeader.textContent = `Chat with ${fallbackEmail}`;
  }

  loadConversation(recipientId);
}

function loadConversation(senderId) {
  const messagesRef = collection(db, "messages");
  const q = query(messagesRef, orderBy("timestamp"));

  onSnapshot(q, snapshot => {
    messagesEl.innerHTML = "";

    snapshot.forEach(docSnap => {
      const msg = docSnap.data();
      const isConversation =
        (msg.senderId === currentUser.uid && msg.recipientId === senderId) ||
        (msg.senderId === senderId && msg.recipientId === currentUser.uid);

      if (isConversation) {
        const msgEl = document.createElement("div");
        msgEl.classList.add("message", msg.senderId === currentUser.uid ? "sent" : "received");
        msgEl.innerHTML = `
          <div class="sender">${msg.senderName || "Anonymous"}</div>
          <div>${msg.text}</div>
        `;
        messagesEl.appendChild(msgEl);
      }
    });

    // Scroll to the bottom
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });
}

  sendBtn.addEventListener("click", async () => {
    const text = messageInput.value.trim();
    if (!text || !activeSenderId || !currentUser) return;

    await addDoc(collection(db, "messages"), {
      senderId: currentUser.uid,
      senderName: currentUser.displayName || "Anonymous",
      recipientId: activeSenderId,
      text,
      timestamp: serverTimestamp()
    });

    messageInput.value = "";
  });
  function goBackToUserList() {
  document.getElementById("chatContainer").style.display = "none";
  document.querySelector(".sidebar").style.display = "block";
}
window.goBackToUserList = function () {
  document.getElementById("chatContainer").style.display = "none";
  document.getElementById("messageListView").style.display = "block";
};
import { setDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

async function openChat(senderId, fallbackName) {
  activeSenderId = senderId;
  chatInputContainer.style.display = "flex";
  document.getElementById("chatContainer").style.display = "flex";
  document.getElementById("messageListView").style.display = "none";

  await setDoc(doc(db, "users", currentUser.uid, "chatStatus", senderId), {
    lastOpened: serverTimestamp()
  });

  // Existing code...
  try {
    const userDocRef = doc(db, "users", senderId);
    const userDocSnap = await getDoc(userDocRef);
    let displayName = "Unknown User";
    let isVerified = false;

    if (userDocSnap.exists()) {
      const userData = userDocSnap.data();
      displayName = userData.username || "Unknown User";
      isVerified = userData.isVerified === true;
    }

    chatHeader.textContent = `Chat with ${displayName}${isVerified ? " ✅" : ""}`;
  } catch (e) {
    chatHeader.textContent = `Chat with ${fallbackName}`;
  }

  loadConversation(senderId);
}
document.addEventListener("DOMContentLoaded", async () => {
  const convoId = localStorage.getItem("convoId");
  const chatWithName = localStorage.getItem("chatWithName");

  if (convoId) {
    openChatWithUser(convoId, chatWithName); // Call your existing logic
  }
});
document.addEventListener("DOMContentLoaded", () => {
    const hamburger = document.getElementById("hamburger");
    const mobileMenu = document.getElementById("mobileMenu");

    if (hamburger && mobileMenu) {
      hamburger.addEventListener("click", () => {
        mobileMenu.classList.toggle("show");
      });
    }
  });

document.addEventListener("click", function (e) {
  const mobileMenu = document.getElementById("mobileMenu");
  const hamburger = document.getElementById("hamburger");

  const clickedInsideMenu = mobileMenu.contains(e.target);
  const clickedHamburger = hamburger.contains(e.target);

  if (!clickedInsideMenu && !clickedHamburger) {
    mobileMenu.classList.remove("show");
  }
});
searchInput.addEventListener("input", async (e) => {
  const query = e.target.value.trim().toLowerCase();
  userListEl.innerHTML = "";

  if (!query || !currentUser) return;

  const messagesRef = collection(db, "messages");
  const msgQuery = query(messagesRef, orderBy("timestamp"));
  const snapshot = await getDocs(msgQuery); // ✅ FIXED

  const addedUserIds = new Set();

  snapshot.forEach(docSnap => {
    const msg = docSnap.data();
    const otherUserId = msg.senderId === currentUser.uid ? msg.recipientId : msg.senderId;

    if (
      (msg.senderId === currentUser.uid || msg.recipientId === currentUser.uid) &&
      !addedUserIds.has(otherUserId)
    ) {
      addedUserIds.add(otherUserId);

      getDoc(doc(db, "users", otherUserId)).then(userDocSnap => {
        if (!userDocSnap.exists()) return;

        const userData = userDocSnap.data();
        const username = userData.username?.toLowerCase() || "";

        if (username.includes(query)) {
          const avatarUrl = userData.avatar || "/images/avatars/popstarpenguin.jpg";
          const isVerified = userData.isVerified === true;

          const userEl = document.createElement("div");
          userEl.classList.add("user-block");

          userEl.innerHTML = `
            <img class="user-avatar" src="${avatarUrl}" />
            <div class="user-name">
              ${userData.username}${isVerified ? " ✅" : ""}
            </div>
          `;

          userEl.onclick = () => openChat(otherUserId, userData.username);
          userListEl.appendChild(userEl);
        }
      });
    }
  });
});

</script>

</body>
</html>
