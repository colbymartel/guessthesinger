<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Direct Messages | Guessing Games</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Performance optimizations */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(to bottom, #ffffff, #e7f1f9);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      /* Optimize for performance */
      will-change: auto;
      contain: layout style paint;
    }

    header {
      background: linear-gradient(135deg, #3b7bbf, #234d7d);
      padding: 40px 20px;
      text-align: center;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .header .logo img {
      width: 200px;
      height: auto;
      margin: 0 auto;
      display: block;
    }

    nav {
      background-color: #1e2b38;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      width: 100%;
    }

    .nav-links a {
      color: white;
      margin: 0 15px;
      text-decoration: none;
      font-weight: bold;
    }

    .nav-links a:hover {
      color: #ffcb05;
    }

    .hamburger {
      display: none;
      font-size: 24px;
      cursor: pointer;
      color: white;
    }

    .mobile-menu {
      display: none;
      flex-direction: column;
      position: absolute;
      right: 15px;
      top: 70px;
      background-color: #1e2b38;
      padding: 10px 20px;
      border-radius: 10px;
      z-index: 1000;
      width: max-content;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .mobile-menu a {
      color: white;
      text-decoration: none;
      padding: 10px 0;
      font-weight: bold;
    }

    .mobile-menu a:hover {
      color: #ffcb05;
    }

    .mobile-menu.show {
      display: flex;
    }

    main {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px);
      flex: 1;
    }

    .sidebar {
      background: white;
      color: #1e2b38;
      padding: 20px;
      overflow-y: auto;
      border-radius: 16px;
      margin: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .chat-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 60px; /* Leave space for footer */
      display: none;
      background: white;
      z-index: 1000;
      flex-direction: column;
      display: flex;
    }

    .chat-header {
      font-size: 1.4em;
      color: #1e2b38;
      font-weight: bold;
      padding: 15px 20px;
      background: linear-gradient(135deg, #4a90e2, #357ab8);
      color: white;
      text-align: center;
      flex-shrink: 0;
      margin: 0;
      border-bottom: 1px solid #e1f0ff;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1002;
    }

    .message {
      background: #f7faff;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 2px solid #e1f0ff;
      transition: all 0.2s ease;
    }

    .message.sent {
      background: linear-gradient(135deg, #4a90e2, #357ab8);
      color: white;
      align-self: flex-end;
      border-color: #4a90e2;
    }

    .message.received {
      background: #f7faff;
      color: #1e2b38;
      align-self: flex-start;
      border-color: #e1f0ff;
    }

    .message-text {
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      text-align: right;
    }

    .message.sent .message-time {
      text-align: right;
    }

    .message.received .message-time {
      text-align: left;
    }

    .chat-input {
      display: flex;
      gap: 12px;
      padding: 15px 20px;
      background: #f8f9fa;
      flex-shrink: 0;
      border-top: 1px solid #e1f0ff;
      position: sticky;
      bottom: 0;
      z-index: 1001;
    }

    .chat-input input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 10px;
      border: 2px solid #e1f0ff;
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    .chat-input input:focus {
      outline: none;
      border-color: #4a90e2;
    }

    .chat-input button {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(to bottom, #4a90e2, #357ab8);
      color: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2), 0 4px 6px rgba(0,0,0,0.1);
    }

    .chat-input button:hover {
      background: #357ab8;
      transform: translateY(-1px);
    }

    .user-block {
      padding: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      border: 2px solid #e1f0ff;
      border-radius: 12px;
      margin-bottom: 10px;
      background: #f7faff;
      transition: all 0.2s ease;
      /* Performance optimizations */
      contain: layout style;
      will-change: transform, background-color;
    }

    .user-block:hover {
      background: #e1f0ff;
      border-color: #4a90e2;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(74, 144, 226, 0.2);
    }

    .user-block.unread {
      border-color: #ff6b6b;
      background: #fff5f5;
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
    }

    .user-block.unread:hover {
      background: #ffe8e8;
      border-color: #ff5252;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }

    .unread-badge {
      background: #ff6b6b;
      color: white;
      border-radius: 50%;
      width: 8px;
      height: 8px;
      display: inline-block;
      margin-left: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 15px;
      border: 3px solid #4a90e2;
      object-fit: cover;
    }

    .user-name {
      font-weight: bold;
      color: #1e2b38;
      font-size: 1.1rem;
    }

    /* Featured Game Banner Styles */
    .featured-game {
      background: linear-gradient(135deg, #3b7bbf, #234d7d);
      color: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      margin: 20px;
      box-shadow: 0 10px 30px rgba(59, 123, 191, 0.3);
      position: relative;
      overflow: hidden;
    }

    .featured-game::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      animation: shimmer 4s infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%) translateY(-100%) rotate(45deg);
      }
      100% {
        transform: translateX(100%) translateY(100%) rotate(45deg);
      }
    }

    .featured-game-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 25px;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }

    .featured-singer-image {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.3);
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }

    .featured-singer-image:hover {
      transform: scale(1.05);
    }

    .featured-singer-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .featured-text-content {
      text-align: left;
      max-width: 350px;
    }

    .featured-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
      font-family: 'Fredoka', sans-serif;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .featured-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
      position: relative;
      z-index: 2;
    }

    .play-now-btn {
      background: #3b7bbf;
      color: white;
      border: 2px solid #b0e0e6;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      font-family: 'Fredoka', sans-serif;
    }

    .play-now-btn:hover {
      background: #5f9ea0;
      transform: translateY(-2px);
    }

    .login-btn {
      background: #ffcb05;
      color: #333;
      border: 2px solid #ffd700;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      font-family: 'Fredoka', sans-serif;
    }

    .login-btn:hover {
      background: #ffd700;
      transform: translateY(-2px);
    }

    /* Main content wrapper */
    .main-content-wrapper {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
      overflow-y: auto;
      padding-bottom: 60px; /* Ensure content doesn't get hidden behind fixed footer */
    }

    .featured-section {
      flex-shrink: 0;
    }

    .messages-section {
      flex: 1;
      display: none;
    }

    .messages-section.show {
      display: block;
    }

    .unread-icon {
      color: #ffcb05;
      font-size: 16px;
      margin-left: 8px;
    }

    .dm-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .dm-tabs .tab {
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      background: #e1f0ff;
      color: #1e2b38;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .dm-tabs .tab:hover {
      background: #4a90e2;
      color: white;
    }

    .dm-tabs .tab.active {
      background: linear-gradient(135deg, #4a90e2, #357ab8);
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-bar {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      margin-bottom: 20px;
    }

    .search-bar input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 10px;
      border: 2px solid #e1f0ff;
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #4a90e2;
    }

    .search-bar .filter-btn {
      margin-left: 10px;
      padding: 12px 20px;
      border: none;
      background: linear-gradient(to bottom, #4a90e2, #357ab8);
      color: white;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .search-bar .filter-btn:hover {
      background: #357ab8;
      transform: translateY(-1px);
    }

    .back-btn {
      background: linear-gradient(135deg, #4a90e2, #357ab8);
      border: none;
      color: white;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      padding: 12px 20px;
      border-radius: 10px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .back-btn:hover {
      background: #357ab8;
      transform: translateY(-1px);
    }

    /* Coin display styles from dailygame.html */
    .coin-emoji {
      width: 24px;
      height: 24px;
      background: radial-gradient(circle at 30% 30%, #ffd700, #f1c40f);
      border-radius: 50%;
      box-shadow:
        0 2px 0 #cfa300,
        0 4px 0 #b8860b,
        0 6px 0 #8c6e00;
      position: relative;
      display: inline-block;
    }

    .coin-emoji::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 30% 30%, #ffe066, transparent);
      border-radius: 50%;
      z-index: 1;
    }

    .welcome-msg {
      font-weight: bold;
      color: #ffcb05;
      cursor: pointer;
    }

    .welcome-msg:hover {
      text-decoration: underline;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 40px;
      margin-right: 30px;
      background-color: #1e2b38;
      padding: 10px;
      border-radius: 10px;
      flex-direction: column;
      min-width: 150px;
      z-index: 10;
    }

    .dropdown.show {
      display: flex;
    }

    .dropdown a {
      color: white;
      text-decoration: none;
      padding: 8px 12px;
      font-weight: bold;
    }

    .dropdown a:hover {
      background-color: #ffcb05;
      color: #1e2b38;
    }

    .bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100%;
  background: #1e2b38;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 8px 0;
  z-index: 9999;
  box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
  height: 60px; /* Fixed height for consistency */
}

    .bottom-nav .nav-item {
      color: white;
      text-align: center;
      text-decoration: none;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .bottom-nav .nav-item i,
    .bottom-nav .nav-item img {
      display: block;
      font-size: 20px;
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .bottom-nav .nav-item:hover {
      color: #ffcb05;
    }

    body {
      padding-bottom: 60px; /* ensures content doesn't get hidden behind bottom nav */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0;
      overflow-x: hidden;
    }

    @media (max-width: 768px) {
      .nav-links {
        display: none;
      }

      .hamburger {
        display: block;
      }

      .sidebar {
        padding: 15px;
        font-size: 0.9em;
        margin: 10px;
      }

      .chat-container {
        margin: 10px;
        height: calc(100vh - 180px); /* Adjust for mobile */
      }

      .chat-input {
        padding: 12px 15px;
        /* Ensure input stays above keyboard */
        position: fixed;
        bottom: 60px; /* Above bottom nav */
        left: 10px;
        right: 10px;
        border-radius: 12px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      }

      .chat-input input,
      .chat-input button {
        padding: 12px;
      }

      .header .logo img {
        width: 160px;
      }

      .user-block {
        padding: 12px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
      }

      /* Adjust messages container for fixed input */
      #messages {
        padding-bottom: 80px; /* Space for fixed input */
      }
    }

    /* Handle keyboard appearance on mobile */
    @media (max-width: 768px) and (max-height: 600px) {
      .chat-container {
        height: calc(100vh - 120px);
      }
      
      .chat-input {
        bottom: 60px;
      }
    }

    /* Use CSS custom property for dynamic keyboard height */
    :root {
      --keyboard-height: 0px;
    }

    @media (max-width: 768px) {
      .chat-input {
        bottom: calc(60px + var(--keyboard-height));
      }
      
      #messages {
        padding-bottom: calc(80px + var(--keyboard-height));
      }
    }

    /* Ensure input stays focused and visible */
    .chat-input input:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }

    /* Smooth scrolling for messages */
    #messages {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch; /* iOS momentum scrolling */
    }

    /* Touch-friendly input on mobile */
    @media (max-width: 768px) {
      .chat-input input {
        font-size: 16px; /* Prevents zoom on iOS */
        min-height: 44px; /* Touch target size */
      }
      
      .chat-input button {
        min-height: 44px;
        min-width: 44px;
      }
    }

.avatar-strip {
  display: flex;
  overflow-x: auto;
  padding: 10px 0;
  gap: 12px;
}

.avatar-bubble {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 12px;
}

.avatar-bubble img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 2px solid #ffcb05;
  object-fit: cover;
}
#messages {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 15px 20px;
  overflow-y: auto;
  flex: 1;
  background-color: #f8f9fc;
  min-height: 0; /* Important for flex child */
  margin: 0; /* Remove any default margins */
  padding-top: 70px; /* Space for fixed header */
  padding-bottom: 80px; /* Space for chat input */
  height: 100%;
}

.message {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 20px;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
  position: relative;
  transition: all 0.2s ease;
}

.message.sent {
  align-self: flex-end;
  background-color: #d2e3fc;
  border-bottom-right-radius: 4px;
}

.message.received {
  align-self: flex-start;
  background-color: #ffffff;
  border-bottom-left-radius: 4px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.sender {
  font-size: 11px;
  color: #777;
  margin-bottom: 4px;
}
#messages {
  scroll-behavior: smooth;
}
.chat-input {
  border-top: 1px solid #ccc;
  background-color: #fff;
  padding: 12px;
}
.chat-input input {
  border-radius: 20px;
}
.back-btn {
  background: none;
  border: none;
  color: #315f85;
  font-weight: bold;
  font-size: 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
  padding: 6px 10px;
  border-radius: 8px;
  transition: background 0.2s ease;
}

.back-btn:hover {
  background-color: #e0ecf7;
}
.modal-content {
  max-height: 90vh;
  overflow-y: auto;
  padding-bottom: 100px; /* prevents keyboard from covering buttons */
}
body, html {
  scroll-padding-bottom: 120px;
}
input, textarea, select {
  font-size: 16px;
}

.scroll-area {
  max-height: 300px; /* adjust as needed */
  overflow-y: auto;
  padding-bottom: 80px; /* leaves space for the keyboard */
}

.bottom-nav {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #1e2b38;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 8px 0;
  z-index: 999;
  box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
}

.bottom-nav .nav-item {
  color: white;
  text-align: center;
  text-decoration: none;
  font-size: 12px;
}

.bottom-nav .nav-item i {
  display: block;
  font-size: 20px;
  margin-bottom: 2px;
}

.bottom-nav .nav-item:hover {
  color: #ffcb05;
}

body {
  padding-bottom: 70px; /* ensures content doesn't get hidden behind bottom nav */
}

.highlight {
  color: #ffcb05; /* yellow */
}

.highlight i {
  color: #ffcb05; /* yellow */
}.user-search-wrapper {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
  margin-bottom: 20px;
  padding: 0;
}

.user-search-wrapper i {
  color: #4a90e2;
  font-size: 18px;
}

.user-search-input {
  flex: 1;
  padding: 12px 16px;
  border: 2px solid #e1f0ff;
  border-radius: 10px;
  font-size: 1rem;
  transition: border-color 0.2s ease;
}

.user-search-input:focus {
  outline: none;
  border-color: #4a90e2;
}

.online-indicator {
  width: 12px;
  height: 12px;
  background: #4CAF50;
  border-radius: 50%;
  border: 2px solid white;
  position: absolute;
  top: 8px;
  right: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  z-index: 1;
}

.user-block {
  position: relative;
}

  </style>

  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <a href="/index.html">
        <img src="images/SingerLogo.png" alt="Guess the Singer Logo" loading="lazy">
      </a>
    </div>
  </header>
  
  <nav style="display: flex; align-items: center; justify-content: space-between;">
    <div style="display: flex; align-items: center; gap: 20px;">
      <div class="welcome-nav" style="position: relative;">
        <div id="welcomeMessage" class="welcome-msg">Welcome</div>
        <div id="dropdownMenu" class="dropdown"></div>
      </div>
      <!-- Coin Display aligned next to Welcome -->
      <div id="coinDisplay" style="display: flex; align-items: center; gap: 6px;">
        <div class="coin-emoji"></div>
        <span id="coinCount" style="font-weight: bold;">0</span>
      </div>
    </div>
    <!-- Hamburger menu on far right -->
    <div class="hamburger" id="hamburger">
      <i class="fas fa-bars"></i>
    </div>
  </nav>
  
  <div id="mobileMenu" class="mobile-menu">
    <a href="/profile.html" class="nav-item">
      <i class="fas fa-user"></i>
      <span>My Profile</span>
    </a>
    <a href="/games.html">Games</a>
    <a href="/about.html">About</a>
  </div>

  <main style="width: 100%; height: calc(100vh - 170px); flex: 1; position: relative;">
    <div class="main-content-wrapper">
      <!-- Featured Game Banner -->
      <div class="featured-section">
        <div class="featured-game">
          <div class="featured-game-content">
            <div class="featured-singer-image">
              <img src="/images/avatars/popstarpenguin.jpg" alt="Challenge Colby">
            </div>
            <div class="featured-text-content">
              <h2 class="featured-title">Challenge Colby</h2>
              <div class="featured-subtitle">Challenge Colby to guess your favorite singer</div>
            </div>
          </div>
          <div class="button-group" id="featuredButtons">
            <!-- Buttons will be dynamically added here -->
          </div>
        </div>
      </div>

      <!-- Messages Section -->
      <div class="messages-section" id="messageListView">
        <div class="sidebar">
          <div class="user-search-wrapper" id="userSearchWrapper" style="display: none;">
            <i class="fas fa-search"></i>
            <input
              type="text"
              id="userSearchInput"
              class="user-search-input"
              placeholder="Search users by name or favorite artist"
            />
          </div>
       
        <div class="dm-tabs">
          <button class="tab active">Friends</button>
          <button class="tab">General</button>
          <button class="tab">Requests</button>
        </div>
        
          <div id="userList"></div>
        </div>
      </div>
    </div>
  
    <!-- Full-screen conversation -->
    <div class="chat-container" id="chatContainer" style="display: none;">
      <div class="chat-header" id="chatHeader">Chat with Colby</div>
      <div id="messages"></div>
      <div class="chat-input" style="display:none;" id="chatInputContainer">
        <input type="text" id="messageInput" placeholder="Can you guess my favorite music artist?">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </main>
  <footer class="bottom-nav">
    <a href="/index.html" class="nav-item">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
    <a href="/games.html" class="nav-item highlight">
      <i class="fas fa-gamepad"></i>
      <span>Games</span>
    </a>
    <a href="/memory-leaderboard.html" class="nav-item">
      <i class="fas fa-trophy"></i>
      <span>Leaderboards</span>
    </a>
    <a href="/rewards.html" class="nav-item">
      <i class="fas fa-gift"></i>
      <span>Rewards</span>
    </a>
  </footer>
  
<script type="module">import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
import {
  getFirestore,
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  addDoc,
  serverTimestamp,
  doc,
  getDoc,
  getDocs,
  setDoc,
  updateDoc,
  deleteDoc,
  limit
} from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';
  
  const firebaseConfig = {
    apiKey: "AIzaSyD36qSJ8YAPc3A4FL9jlBGlpiWwj530SPQ",
    authDomain: "guessthesinger10.firebaseapp.com",
    projectId: "guessthesinger10",
    storageBucket: "guessthesinger10.appspot.com",
    messagingSenderId: "97201023235",
    appId: "1:97201023235:web:ab111d9acb43ef7d4be136"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const messagesRef = collection(db, "messages");
  const auth = getAuth();
  
  let currentUser = null;
  let activeChatUserId = null;
  let activeTab = "friends"; // default tab
  
  const userListEl = document.getElementById("userList");
  const messagesEl = document.getElementById("messages");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatHeader = document.getElementById("chatHeader");
  const chatInputContainer = document.getElementById("chatInputContainer");
  const tabs = document.querySelectorAll(".dm-tabs .tab");
  
  // Setup tab switching UI and logic
  tabs.forEach(tabEl => {
    tabEl.addEventListener("click", () => {
      if (tabEl.classList.contains("active")) return;
      tabs.forEach(t => t.classList.remove("active"));
      tabEl.classList.add("active");
      activeTab = tabEl.textContent.toLowerCase();
      if (currentUser) {
        loadConversationsByTab(activeTab);
      }
    });
  });

  // Hide tabs and search bar for regular users (non-admin)
  function updateTabVisibility() {
    if (currentUser) {
      const isAdmin = currentUser.email === 'colbyma23@gmail.com';
      const dmTabs = document.querySelector('.dm-tabs');
      const userSearchWrapper = document.getElementById('userSearchWrapper');
      
      if (dmTabs) {
        dmTabs.style.display = isAdmin ? 'flex' : 'none';
      }
      
      if (userSearchWrapper) {
        userSearchWrapper.style.display = isAdmin ? 'flex' : 'none';
      }
    }
  }
  
  // Utility: Render a user block with an optional action button to move conversation
  function renderUserBlock(userData, isUnread, moveActionLabel, onMoveClick, onClick, lastMessageTime = null, onDeleteClick = null) {
    const userEl = document.createElement("div");
    userEl.classList.add("user-block");
    if (isUnread) {
      userEl.classList.add("unread");
      userEl.style.borderColor = "#ff6b6b";
      userEl.style.backgroundColor = "#fff5f5";
      userEl.style.boxShadow = "0 2px 8px rgba(255, 107, 107, 0.2)";
    }

    // Determine online status (simulate based on last activity or recent messages)
    const isOnline = (userData.lastSeen && (Date.now() - userData.lastSeen.toMillis()) < 300000) || // 5 minutes from lastSeen
                     (lastMessageTime && (Date.now() - lastMessageTime) < 300000); // 5 minutes from last message
    const onlineStatus = isOnline ? '<div class="online-indicator"></div>' : '';

    // Format last message time
    let timeDisplay = '';
    if (lastMessageTime) {
      const now = new Date();
      const messageDate = new Date(lastMessageTime);
      const diffInHours = (now - messageDate) / (1000 * 60 * 60);
      
      if (diffInHours < 1) {
        timeDisplay = messageDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      } else if (diffInHours < 24) {
        timeDisplay = messageDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      } else if (diffInHours < 48) {
        timeDisplay = 'Yesterday';
      } else {
        timeDisplay = messageDate.toLocaleDateString([], {month: 'short', day: 'numeric'});
      }
    }
  
    userEl.innerHTML = `
      <div style="position: relative; display: flex; align-items: center; flex: 1;">
        <div style="position: relative;">
          <img class="user-avatar" src="${userData.avatar || '/images/avatars/popstarpenguin.jpg'}" alt="Avatar" />
          ${onlineStatus}
        </div>
        <div style="flex: 1; margin-left: 15px;">
          <div class="user-name" style="font-weight:${isUnread ? 'bold' : 'normal'}; color:${isUnread ? '#d63031' : '#1e2b38'};">
            ${userData.username || "Unknown User"} ${userData.isVerified ? "âœ…" : ""}
            ${isUnread ? '<span class="unread-badge" style="background:#ff6b6b; color:white; border-radius:50%; width:8px; height:8px; display:inline-block; margin-left:8px;"></span>' : ''}
          </div>
          <div class="user-message-preview" style="font-size: 0.85rem; color: #666; margin-top: 2px; font-style: italic; display: none;">
            <!-- Message preview will be inserted here -->
          </div>
        </div>
        ${timeDisplay ? `<div style="font-size: 0.8rem; color: #666; margin-left: auto; margin-right: 15px;">${timeDisplay}</div>` : ''}
      </div>
    `;
  
    // Add action buttons if provided
    if (moveActionLabel && onMoveClick) {
      const buttonContainer = document.createElement("div");
      buttonContainer.style.marginLeft = "auto";
      buttonContainer.style.display = "flex";
      buttonContainer.style.gap = "8px";
      buttonContainer.style.alignItems = "center";

      // Add delete button if handler is provided
      if (onDeleteClick) {
        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.style.padding = "4px 8px";
        deleteBtn.style.backgroundColor = "#dc3545";
        deleteBtn.style.color = "white";
        deleteBtn.style.border = "none";
        deleteBtn.style.borderRadius = "6px";
        deleteBtn.style.cursor = "pointer";
        deleteBtn.style.fontSize = "0.8rem";
        deleteBtn.title = "Delete conversation";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm("Are you sure you want to delete this conversation? This action cannot be undone.")) {
            onDeleteClick();
          }
        };
        buttonContainer.appendChild(deleteBtn);
      }

      // Add move button
      const moveBtn = document.createElement("button");
      moveBtn.textContent = moveActionLabel;
      moveBtn.style.padding = "4px 8px";
      moveBtn.style.backgroundColor = "#315f85";
      moveBtn.style.color = "white";
      moveBtn.style.border = "none";
      moveBtn.style.borderRadius = "6px";
      moveBtn.style.cursor = "pointer";
      moveBtn.style.fontSize = "0.8rem";
      moveBtn.onclick = (e) => {
        e.stopPropagation();
        onMoveClick();
      };
      buttonContainer.appendChild(moveBtn);

      userEl.style.display = "flex";
      userEl.style.alignItems = "center";
      userEl.appendChild(buttonContainer);
    }
  
    userEl.onclick = onClick;
    return userEl;
  }
  
  // Load conversations, split by tab
  async function loadConversationsByTab(tab) {
    if (!currentUser) return;

    // Show better loading state
    userListEl.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #666;">
        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px; color: #4a90e2;"></i>
        <p>Loading conversations...</p>
      </div>
    `;

    // Check if current user is admin (colbyma23@gmail.com)
    const isAdmin = currentUser.email === 'colbyma23@gmail.com';

    if (!isAdmin) {
      // For regular users, show only "Challenge Colby" option
      userListEl.innerHTML = `
        <div style="padding: 15px; background: linear-gradient(135deg, #ffcb05, #ffd700); border-radius: 8px; margin-bottom: 15px; text-align: center; color: #1e2b38; font-weight: bold;">
          <i class="fas fa-trophy" style="margin-right: 8px;"></i>
          Challenge Colby to Guess YOUR Mystery Singer!
        </div>
      `;
      
      // Create Colby user data
      const colbyUserData = {
        username: "Colby",
        avatar: "/images/avatars/popstarpenguin.jpg",
        isVerified: true
      };

      try {
        // Check if there are any unread messages from Colby
        const messagesRef = collection(db, "messages");
        const colbyMessagesQuery = query(
          messagesRef,
          where("participants", "array-contains", currentUser.uid),
          orderBy("timestamp", "desc")
        );
        
        const colbyMessagesSnapshot = await getDocs(colbyMessagesQuery);
        let isUnread = false;
        let latestMessageTime = 0;
        
        // Find Colby's user ID by searching for the admin email
        const usersSnapshot = await getDocs(collection(db, "users"));
        let colbyUserId = null;
        
        usersSnapshot.forEach(docSnap => {
          const userData = docSnap.data();
          if (userData.email === 'colbyma23@gmail.com') {
            colbyUserId = docSnap.id;
          }
        });

        if (colbyUserId) {
          // Check for unread messages from Colby
          colbyMessagesSnapshot.forEach(docSnap => {
            const msg = docSnap.data();
            if ((msg.senderId === colbyUserId && msg.recipientId === currentUser.uid) ||
                (msg.senderId === currentUser.uid && msg.recipientId === colbyUserId)) {
              if (!latestMessageTime || msg.timestamp?.toMillis() > latestMessageTime) {
                latestMessageTime = msg.timestamp?.toMillis() || 0;
              }
            }
          });

          // Check unread status
          const chatStatusSnap = await getDoc(doc(db, "users", currentUser.uid, "chatStatus", colbyUserId));
          const lastOpened = chatStatusSnap.exists() ? chatStatusSnap.data().lastOpened?.toMillis() || 0 : 0;
          isUnread = !lastOpened || latestMessageTime > lastOpened;
        }

        const userEl = renderUserBlock(
          colbyUserData,
          isUnread,
          null, // no move button
          null,
          () => openChatWithUser(colbyUserId, "Colby"),
          latestMessageTime,
          null // no delete button for Colby
        );

        userListEl.appendChild(userEl);
        return;
      } catch (error) {
        console.error("Error loading chat data:", error);
        
        // If there's a permissions error, show a simplified version
        if (error.code === 'permission-denied') {
          userListEl.innerHTML = `
            <div style="padding: 15px; background: linear-gradient(135deg, #ffcb05, #ffd700); border-radius: 8px; margin-bottom: 15px; text-align: center; color: #1e2b38; font-weight: bold;">
              <i class="fas fa-trophy" style="margin-right: 8px;"></i>
              Challenge Colby to Guess YOUR Mystery Singer!
            </div>
            <div style="padding: 10px; background: #f8d7da; border-radius: 8px; margin-bottom: 15px; text-align: center; color: #721c24; font-size: 0.9rem;">
              <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
              Chat features are being set up. You can still challenge Colby!
            </div>
          `;
          
          // Create a simple challenge button that doesn't require chat permissions
          const challengeBtn = document.createElement("div");
          challengeBtn.className = "user-block";
          challengeBtn.style.cursor = "pointer";
          challengeBtn.innerHTML = `
            <div style="position: relative; display: flex; align-items: center; flex: 1;">
              <div style="position: relative;">
                <img class="user-avatar" src="/images/avatars/popstarpenguin.jpg" alt="Colby" />
                <div class="online-indicator"></div>
              </div>
              <div style="flex: 1; margin-left: 15px;">
                <div class="user-name">Challenge Colby</div>
              </div>
            </div>
          `;
          challengeBtn.onclick = () => {
            alert("ðŸŽµ Challenge Colby! Chat features coming soon!");
          };
          userListEl.appendChild(challengeBtn);
          return;
        }
      }
    }

    // For admin, show all active chats (enhanced logic)
    try {
      // Step 1: Get all conversations user has a conversation doc for (i.e., categorized)
      const convsRef = collection(db, "users", currentUser.uid, "conversations");
      const convsSnapshot = await getDocs(convsRef);
      const categorizedConversations = {};
      const seenUsers = new Set(); // Track users to prevent duplicates
      
      convsSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const userId = docSnap.id;
        
        // Only add if we haven't seen this user before
        if (!seenUsers.has(userId)) {
          categorizedConversations[userId] = data.tab || "friends";
          seenUsers.add(userId);
        }
      });

      // Step 2: Get all messages involving current user
      const messagesRef = collection(db, "messages");

      const messagesQuery = query(
        messagesRef,
        where("participants", "array-contains", currentUser.uid),
        orderBy("timestamp", "desc")
      );

      const messagesSnapshot = await getDocs(messagesQuery);

      // Track unique users who messaged or received messages by current user
      const messagedUserIds = new Set();
      const incomingNewUsers = new Set(); // For requests tab

      // Track latest message per user for unread check and sorting
      const latestMessages = {};
      const conversationData = {};
      const uniqueConversations = new Set(); // Track unique conversations

      messagesSnapshot.forEach(docSnap => {
        const msg = docSnap.data();
        if (msg.senderId !== currentUser.uid && msg.recipientId !== currentUser.uid) return;

        const otherUserId = msg.senderId === currentUser.uid ? msg.recipientId : msg.senderId;
        
        // Ensure we only track unique conversations
        if (uniqueConversations.has(otherUserId)) {
          // If we've already seen this user, only update if this message is more recent
          if (msg.timestamp?.toMillis() > (latestMessages[otherUserId] || 0)) {
            latestMessages[otherUserId] = msg.timestamp?.toMillis() || 0;
            conversationData[otherUserId] = {
              lastMessageTime: msg.timestamp?.toMillis() || 0,
              lastMessageText: msg.text || "",
              lastMessageSender: msg.senderId === currentUser.uid ? "You" : "Them",
              hasUnread: false
            };
          }
          return;
        }
        
        uniqueConversations.add(otherUserId);
        messagedUserIds.add(otherUserId);

        // Save latest timestamp and message data for each conversation
        latestMessages[otherUserId] = msg.timestamp?.toMillis() || 0;
        conversationData[otherUserId] = {
          lastMessageTime: msg.timestamp?.toMillis() || 0,
          lastMessageText: msg.text || "",
          lastMessageSender: msg.senderId === currentUser.uid ? "You" : "Them",
          hasUnread: false
        };
      });

      // Step 3: Check unread status and auto-categorize conversations (optimized)
      const chatStatusPromises = Array.from(messagedUserIds).map(async (otherUserId) => {
        const chatStatusSnap = await getDoc(doc(db, "users", currentUser.uid, "chatStatus", otherUserId));
        const lastOpened = chatStatusSnap.exists() ? chatStatusSnap.data().lastOpened?.toMillis() || 0 : 0;
        const isUnread = !lastOpened || (latestMessages[otherUserId] || 0) > lastOpened;
        
        if (conversationData[otherUserId]) {
          conversationData[otherUserId].hasUnread = isUnread;
        }

        // Auto-categorize: If there's a conversation and it's not categorized, move to friends
        if (!(otherUserId in categorizedConversations) && latestMessages[otherUserId]) {
          // Find the last message for this conversation from the already fetched messages
          const conversationMessages = messagesSnapshot.docs.filter(docSnap => {
            const msg = docSnap.data();
            return msg.participants && msg.participants.includes(otherUserId);
          });
          
          if (conversationMessages.length > 0) {
            const lastMsg = conversationMessages[0].data();
            // If the last message was from the other user (not from Colby), categorize as friends
            if (lastMsg.senderId === otherUserId) {
              await setDoc(doc(db, "users", currentUser.uid, "conversations", otherUserId), { 
                tab: "friends",
                lastActivity: serverTimestamp()
              });
              categorizedConversations[otherUserId] = "friends";
            }
          }
        }
        
        return { otherUserId, isUnread };
      });

      // Wait for all chat status checks to complete
      await Promise.all(chatStatusPromises);

      // Step 4: Determine users per tab
      let userIdsToShow = [];

      if (tab === "friends" || tab === "general") {
        userIdsToShow = Object.entries(categorizedConversations)
          .filter(([uid, tabName]) => tabName === tab)
          .map(([uid]) => uid);
      } else if (tab === "requests") {
        // Users messaged current user but NOT categorized in conversations subcollection
        userIdsToShow = [...messagedUserIds].filter(uid => !(uid in categorizedConversations));
      }

      // Remove duplicates - ensure each user appears only once
      userIdsToShow = [...new Set(userIdsToShow)];

      if (userIdsToShow.length === 0) {
        userListEl.innerHTML = `<p style="padding: 10px; color: #666;">No conversations in ${tab} tab.</p>`;
        return;
      }

      // Step 5: Sort conversations by recent activity (most recent first)
      userIdsToShow.sort((a, b) => {
        const aTime = conversationData[a]?.lastMessageTime || 0;
        const bTime = conversationData[b]?.lastMessageTime || 0;
        return bTime - aTime; // Most recent first
      });

      // Step 6: Fetch user data & render (optimized)
      userListEl.innerHTML = "";

      // Batch fetch all user data
      const userDataPromises = userIdsToShow.map(async (otherUserId) => {
        const userDocSnap = await getDoc(doc(db, "users", otherUserId));
        if (!userDocSnap.exists()) return null;
        return {
          userId: otherUserId,
          userData: userDocSnap.data(),
          isUnread: conversationData[otherUserId]?.hasUnread || false,
          conversationData: conversationData[otherUserId]
        };
      });

      const userDataResults = await Promise.all(userDataPromises);
      const validUserData = userDataResults.filter(result => result !== null);

      // Render all users at once
      const fragment = document.createDocumentFragment();

      for (const { userId, userData, isUnread, conversationData: convData } of validUserData) {
        // Determine move button label and handler
        let moveBtnLabel = null;
        let moveBtnHandler = null;

        if (tab === "friends") {
          moveBtnLabel = "Move to General";
          moveBtnHandler = async () => {
            await setDoc(doc(db, "users", currentUser.uid, "conversations", userId), { 
              tab: "general",
              lastActivity: serverTimestamp()
            });
            await loadConversationsByTab(activeTab);
          };
        } else if (tab === "general") {
          moveBtnLabel = "Move to Friends";
          moveBtnHandler = async () => {
            await setDoc(doc(db, "users", currentUser.uid, "conversations", userId), { 
              tab: "friends",
              lastActivity: serverTimestamp()
            });
            await loadConversationsByTab(activeTab);
          };
        }

        // Add last message preview for better UX
        const lastMessagePreview = convData?.lastMessageText || "";
        const lastMessageSender = convData?.lastMessageSender || "";
        const previewText = lastMessagePreview.length > 30 ? lastMessagePreview.substring(0, 30) + "..." : lastMessagePreview;

        const userEl = renderUserBlock(
          userData,
          isUnread,
          moveBtnLabel,
          moveBtnHandler,
          () => openChatWithUser(userId, userData.username),
          convData?.lastMessageTime || null,
          () => deleteConversation(userId)
        );

        // Add message preview if available
        if (previewText) {
          const previewEl = userEl.querySelector('.user-message-preview');
          if (previewEl) {
            previewEl.textContent = `${lastMessageSender}: ${previewText}`;
            previewEl.style.display = 'block';
          }
        }

        fragment.appendChild(userEl);
      }

      userListEl.appendChild(fragment);
    } catch (error) {
      console.error("Error loading admin conversations:", error);
      
      if (error.code === 'permission-denied') {
        userListEl.innerHTML = `
          <div style="padding: 15px; background: #f8d7da; border-radius: 8px; margin-bottom: 15px; text-align: center; color: #721c24; font-size: 0.9rem;">
            <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
            Chat permissions need to be updated. Please deploy the new Firestore security rules.
          </div>
        `;
      } else {
        userListEl.innerHTML = `<p style="padding: 10px; color: #666;">Error loading conversations. Please try again.</p>`;
      }
    }
  }
  
    async function openChatWithUser(userId, usernameFallback) {
    if (!currentUser) return;

    activeChatUserId = userId;
    const chatContainer = document.getElementById("chatContainer");
    chatContainer.style.display = "flex";
    chatContainer.style.flexDirection = "column";
    document.getElementById("messageListView").style.display = "none";
    chatInputContainer.style.display = "flex";
    
    // Ensure proper layout
    document.body.style.overflow = "hidden"; // Prevent body scrolling

    // Mark chat as opened (for unread tracking)
    await setDoc(doc(db, "users", currentUser.uid, "chatStatus", userId), {
      lastOpened: serverTimestamp()
    });

    // Automatically categorize the conversation into "friends" tab if it was a request before
    const convDocRef = doc(db, "users", currentUser.uid, "conversations", userId);
    const convSnap = await getDoc(convDocRef);
    if (!convSnap.exists()) {
      // Assign to friends by default when opening from requests
      await setDoc(convDocRef, { 
        tab: "friends",
        lastActivity: serverTimestamp()
      });
    }

    // Fetch user info for header
    let displayName = usernameFallback || "Unknown User";
    let isVerified = false;
    try {
      const userDocSnap = await getDoc(doc(db, "users", userId));
      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        displayName = userData.username || displayName;
        isVerified = userData.isVerified === true;
      }
    } catch {}

    chatHeader.innerHTML = `
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <span>Chat with ${displayName}${isVerified ? " âœ…" : ""}</span>
        <button onclick="closeChat()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 5px;">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;

    loadMessagesRealtime(userId);
    focusChatInput();
    
    // Refresh the conversation list to show updated categorization
    if (currentUser.email === 'colbyma23@gmail.com') {
      loadConversationsByTab(activeTab);
    }
  }

  // Function to close chat and return to conversation list
  function closeChat() {
    document.getElementById("chatContainer").style.display = "none";
    document.getElementById("messageListView").style.display = "block";
    document.body.style.overflow = "auto"; // Restore body scrolling
    activeChatUserId = null;
  }

  // Function to open chat with user ID (for direct access)
  async function openChatWithUserId(userId) {
    if (!currentUser) return;

    try {
      // Fetch user info first
      const userDocSnap = await getDoc(doc(db, "users", userId));
      let displayName = "Unknown User";
      let isVerified = false;
      
      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        displayName = userData.username || displayName;
        isVerified = userData.isVerified === true;
      }

      // Open the chat directly
      activeChatUserId = userId;
      const chatContainer = document.getElementById("chatContainer");
      chatContainer.style.display = "flex";
      chatContainer.style.flexDirection = "column";
      document.getElementById("messageListView").style.display = "none";
      chatInputContainer.style.display = "flex";
      
      // Ensure proper layout
      document.body.style.overflow = "hidden"; // Prevent body scrolling

      // Mark chat as opened (for unread tracking)
      await setDoc(doc(db, "users", currentUser.uid, "chatStatus", userId), {
        lastOpened: serverTimestamp()
      });

      // Categorize the conversation
      const convDocRef = doc(db, "users", currentUser.uid, "conversations", userId);
      const convSnap = await getDoc(convDocRef);
      if (!convSnap.exists()) {
        await setDoc(convDocRef, { tab: "friends" });
      }

      chatHeader.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <span>Chat with ${displayName}${isVerified ? " âœ…" : ""}</span>
          <button onclick="closeChat()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 5px;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      // Add a welcome message if this is a new conversation
      const messagesQuery = query(
        collection(db, "messages"),
        where("participants", "array-contains", currentUser.uid),
        orderBy("timestamp", "desc"),
        limit(1)
      );
      
      const messagesSnapshot = await getDocs(messagesQuery);
      if (messagesSnapshot.empty) {
        // This is a new conversation, add a welcome message
        messagesEl.innerHTML = `
          <div class="message received">
            <div class="sender">Colby</div>
            <div class="message-text">Hey there! ðŸ‘‹ I'm Colby. Feel free to chat with me about music, challenge me to a game, or just say hi!</div>
            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
          </div>
        `;
      }
      
      loadMessagesRealtime(userId);
      focusChatInput();
      
    } catch (error) {
      console.error("Error opening chat:", error);
      
      // Check if it's a permissions error
      if (error.code === 'permission-denied') {
        alert("Chat functionality requires updated permissions. Please contact the administrator to enable chat features.");
      } else {
        alert("Error opening chat. Please try again.");
      }
    }
  }
  
  function loadMessagesRealtime(otherUserId) {
    const messagesRef = collection(db, "messages");
    const q = query(
      messagesRef,
      where("participants", "array-contains", currentUser.uid),
      orderBy("timestamp")
    );

    if (window.unsubscribeMessages) {
      window.unsubscribeMessages();
    }
  
    window.unsubscribeMessages = onSnapshot(q, (snapshot) => {
      messagesEl.innerHTML = "";
  
      snapshot.forEach(docSnap => {
        const msg = docSnap.data();
        if (
          (msg.senderId === currentUser.uid && msg.recipientId === otherUserId) ||
          (msg.senderId === otherUserId && msg.recipientId === currentUser.uid)
        ) {
          const msgEl = document.createElement("div");
          msgEl.classList.add("message", msg.senderId === currentUser.uid ? "sent" : "received");
          
          // Format timestamp
          const timestamp = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
          
          msgEl.innerHTML = `
            <div class="sender">${msg.senderName || "Anonymous"}</div>
            <div class="message-text">${msg.text}</div>
            <div class="message-time">${timestamp}</div>
          `;
          messagesEl.appendChild(msgEl);
        }
      });
  
      // Scroll to bottom to show latest messages
      scrollToBottom();
    }, (error) => {
      console.error("Error loading messages:", error);
      if (error.code === 'permission-denied') {
        messagesEl.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #666;">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <p>Chat permissions need to be updated. Please contact the administrator.</p>
          </div>
        `;
      } else {
        messagesEl.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #666;">
            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <p>Error loading messages. Please try refreshing the page.</p>
          </div>
        `;
      }
    });
  }
  
  sendBtn.addEventListener("click", async () => {
    if (!currentUser || !activeChatUserId) return;
  
    const text = messageInput.value.trim();
    if (!text) return;

    try {
      // Clear input immediately for better UX
      messageInput.value = "";
      
      // Add message to Firestore
      await addDoc(collection(db, "messages"), {
        senderId: currentUser.uid,
        senderName: currentUser.displayName || currentUser.email || "Anonymous",
        recipientId: activeChatUserId,
        text,
        timestamp: serverTimestamp(),
        participants: [currentUser.uid, activeChatUserId]
      });

      // If this is Colby replying, automatically categorize the conversation as "friends"
      if (currentUser.email === 'colbyma23@gmail.com') {
        const convDocRef = doc(db, "users", currentUser.uid, "conversations", activeChatUserId);
        const convSnap = await getDoc(convDocRef);
        if (!convSnap.exists()) {
          // This is a new conversation, categorize as friends
          await setDoc(convDocRef, { 
            tab: "friends",
            lastActivity: serverTimestamp()
          });
        } else {
          // Update last activity
          await updateDoc(convDocRef, { 
            lastActivity: serverTimestamp()
          });
        }
        
        // Refresh the conversation list to show updated categorization
        loadConversationsByTab(activeTab);
      }

      console.log("Message sent successfully");
    } catch (error) {
      console.error("Error sending message:", error);
      // Restore the message text if sending failed
      messageInput.value = text;
      alert("Failed to send message. Please try again.");
    }
  });

  // Also allow sending message with Enter key
  messageInput.addEventListener("keypress", async (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendBtn.click();
    }
  });
  

  
    function setupUserSearch() {
    const userSearchInput = document.getElementById("userSearchInput");

    userSearchInput.addEventListener("input", async () => {
      const queryText = userSearchInput.value.toLowerCase().trim();
      userListEl.innerHTML = "";

      if (!currentUser) return;

      // Check if current user is admin
      const isAdmin = currentUser.email === 'colbyma23@gmail.com';

      if (!isAdmin) {
        // For regular users, disable search and show message
        userSearchInput.value = "";
        userListEl.innerHTML = `<p style="padding:10px; color:#666;">You can only chat with Colby. Use the "Challenge Colby" option above.</p>`;
        return;
      }

      if (queryText.length < 3) {
        userListEl.innerHTML = `<p style="padding:10px; color:#666;">Type at least 3 characters to search.</p>`;
        return;
      }

      const usersSnapshot = await getDocs(collection(db, "users"));
      const matches = [];

      usersSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const username = (data.username || "").toLowerCase();
        const favoriteArtists = Array.isArray(data.favoriteArtist)
          ? data.favoriteArtist.join(", ").toLowerCase()
          : (data.favoriteArtist || "").toLowerCase();

        if ((username.includes(queryText) || favoriteArtists.includes(queryText)) && docSnap.id !== currentUser.uid) {
          matches.push({ uid: docSnap.id, ...data });
        }
      });

      if (matches.length === 0) {
        userListEl.innerHTML = "<p style='padding:10px; color:#666;'>No matches found.</p>";
        return;
      }

      userListEl.innerHTML = matches.slice(0, 10).map(user => `
        <div class="user-block" style="cursor:pointer;">
          <div style="position: relative; display: flex; align-items: center; flex: 1;">
            <div style="position: relative;">
              <img class="user-avatar" src="${user.avatar || '/images/avatars/popstarpenguin.jpg'}" alt="Avatar" />
            </div>
            <div style="flex: 1; margin-left: 15px;">
              <div class="user-name">${user.username || "Anonymous"}</div>
            </div>
          </div>
        </div>
      `).join("");

      Array.from(userListEl.children).forEach((el, i) => {
        el.addEventListener("click", () => openChatWithUser(matches[i].uid, matches[i].username));
      });
    });
  }
  // Function to update featured buttons based on auth state
  function updateFeaturedButtons(user) {
    const featuredButtons = document.getElementById("featuredButtons");
    if (!featuredButtons) return;

    if (!user) {
      // User is not logged in - show login button
      featuredButtons.innerHTML = `
        <a href="/login.html" class="login-btn">Log-In</a>
      `;
    } else {
      // User is logged in - show play now button
      featuredButtons.innerHTML = `
        <a href="#" onclick="openChatWithColby(); return false;" class="play-now-btn">Play Now</a>
      `;
    }
  }

  // Function to open chat with Colby
  function openChatWithColby() {
    if (!currentUser) {
      window.location.href = "/login.html";
      return;
    }
    
    // Show messages section and hide featured section
    document.querySelector('.featured-section').style.display = 'none';
    document.querySelector('.messages-section').classList.add('show');
    
    // Load conversations
    updateTabVisibility();
    setupUserSearch();
    loadConversationsByTab(activeTab);
  }

  // Make functions globally accessible
  window.openChatWithColby = openChatWithColby;
  window.closeChat = closeChat;

  // Show loading state immediately
  document.getElementById("welcomeMessage").textContent = "Loading...";
  document.getElementById("coinDisplay").style.display = "none";
  
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // User is not logged in - show anonymous state
      currentUser = null;
      document.getElementById("welcomeMessage").textContent = "Welcome, Anonymous";
      document.getElementById("welcomeMessage").style.cursor = "pointer";
      document.getElementById("coinDisplay").style.display = "none";
      
      // Update featured buttons for logged out state
      updateFeaturedButtons(null);
      
      // Show login prompt
      userListEl.innerHTML = `
        <div style="padding: 20px; text-align: center; color: #666;">
          <i class="fas fa-user-lock" style="font-size: 3rem; margin-bottom: 15px; color: #4a90e2;"></i>
          <h3 style="margin-bottom: 10px; color: #1e2b38;">Sign in to access your messages</h3>
          <p style="margin-bottom: 20px;">Click "Welcome, Anonymous" above to sign in and start chatting!</p>
          <div style="padding: 15px; background: linear-gradient(135deg, #ffcb05, #ffd700); border-radius: 8px; margin-bottom: 15px; text-align: center; color: #1e2b38; font-weight: bold;">
            <i class="fas fa-trophy" style="margin-right: 8px;"></i>
            Challenge Colby to Guess YOUR Mystery Singer!
          </div>
        </div>
      `;
      return;
    }

    currentUser = user;

    // Update featured buttons for logged in state
    updateFeaturedButtons(user);

    // Update welcome message immediately
    const welcomeMessage = document.getElementById("welcomeMessage");
    const coinDisplay = document.getElementById("coinDisplay");
    
    if (user.displayName) {
      welcomeMessage.textContent = `Welcome, ${user.displayName}`;
    } else if (user.email) {
      welcomeMessage.textContent = `Welcome, ${user.email.split('@')[0]}`;
    } else {
      welcomeMessage.textContent = "Welcome, User";
    }
    
    welcomeMessage.style.cursor = "pointer";
    coinDisplay.style.display = "flex";
    
    // Load user's coin count in background (non-blocking)
    getDoc(doc(db, "users", user.uid))
      .then(userDoc => {
        if (userDoc.exists()) {
          const userData = userDoc.data();
          document.getElementById("coinCount").textContent = userData.coins || 0;
        }
      })
      .catch(error => {
        console.error("Error loading user data:", error);
        document.getElementById("coinCount").textContent = "0";
      });

    // Check if we should automatically open a chat
    const urlParams = new URLSearchParams(window.location.search);
    const openChatUserId = urlParams.get('openChat');
    
    if (openChatUserId) {
      // Clear the URL parameter
      window.history.replaceState({}, document.title, window.location.pathname);
      
      // Find the user data and open the chat directly
      openChatWithUserId(openChatUserId);
    } else {
      // For regular users, show only "Challenge Colby" option
      updateTabVisibility();
      setupUserSearch();
      loadConversationsByTab(activeTab);
    }
    
    // Run backfill in background (non-blocking) - delay longer for better performance
    setTimeout(() => backfillParticipants(), 3000);
    
    // Set up real-time listener for conversation updates (admin only)
    if (user.email === 'colbyma23@gmail.com') {
      setupConversationListener();
    }
  });

  


  async function backfillParticipants() {
    // Only run backfill once per session to avoid performance issues
    if (sessionStorage.getItem('backfillCompleted')) {
      return;
    }

    try {
      const snapshot = await getDocs(
        query(messagesRef, where("participants", "array-contains", currentUser.uid))
      );

      const updatePromises = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (!data.participants && data.senderId && data.recipientId) {
          updatePromises.push(
            updateDoc(docSnap.ref, {
              participants: [data.senderId, data.recipientId]
            })
          );
        }
      });

      if (updatePromises.length > 0) {
        await Promise.all(updatePromises);
      }
      
      // Mark backfill as completed for this session
      sessionStorage.setItem('backfillCompleted', 'true');
    } catch (error) {
      console.error("Error in backfill:", error);
    }
  }

  // Hamburger menu functionality
  const hamburger = document.getElementById("hamburger");
  const mobileMenu = document.getElementById("mobileMenu");
  
  if (hamburger && mobileMenu) {
    hamburger.addEventListener("click", () => {
      mobileMenu.classList.toggle("show");
    });
  }

  // Handle viewport changes for mobile keyboard
  let initialViewportHeight = window.innerHeight;
  
  window.addEventListener('resize', () => {
    const currentHeight = window.innerHeight;
    const heightDifference = initialViewportHeight - currentHeight;
    
    // If height decreased significantly, keyboard is likely open
    if (heightDifference > 150) {
      document.body.style.setProperty('--keyboard-height', `${heightDifference}px`);
    } else {
      document.body.style.setProperty('--keyboard-height', '0px');
    }
  });

  // Set up real-time listener for conversation updates
  function setupConversationListener() {
    if (!currentUser || currentUser.email !== 'colbyma23@gmail.com') return;
    
    const messagesRef = collection(db, "messages");
    const q = query(
      messagesRef,
      where("participants", "array-contains", currentUser.uid),
      orderBy("timestamp", "desc"),
      limit(1)
    );

    if (window.unsubscribeConversations) {
      window.unsubscribeConversations();
    }

    window.unsubscribeConversations = onSnapshot(q, (snapshot) => {
      if (!snapshot.empty) {
        const latestMessage = snapshot.docs[0].data();
        
        // If the latest message is from someone else (not from Colby), refresh the conversation list
        if (latestMessage.senderId !== currentUser.uid) {
          // Small delay to ensure the message is fully processed
          setTimeout(() => {
            loadConversationsByTab(activeTab);
          }, 500);
        }
      }
    }, (error) => {
      console.error("Error in conversation listener:", error);
    });
  }

  // Auto-scroll to bottom when new messages arrive
  function scrollToBottom() {
    const messagesEl = document.getElementById('messages');
    if (messagesEl) {
      setTimeout(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }, 100);
    }
  }

  // Focus input when chat is opened
  function focusChatInput() {
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
      setTimeout(() => {
        messageInput.focus();
      }, 200);
    }
  }

  // Add click handler for welcome message to trigger login
  document.getElementById("welcomeMessage").addEventListener("click", () => {
    if (!currentUser) {
      // User is not logged in, redirect to login page
      window.location.href = "/login.html";
    } else {
      // User is logged in, show dropdown menu
      const dropdown = document.getElementById("dropdownMenu");
      if (dropdown) {
        dropdown.innerHTML = `
          <a href="/profile.html">My Profile</a>
          <a href="#" onclick="handleSignOut(); return false;">Log Out</a>
        `;
        dropdown.classList.toggle("show");
      }
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", (e) => {
    const dropdown = document.getElementById("dropdownMenu");
    const welcomeNav = document.querySelector(".welcome-nav");
    
    if (dropdown && !welcomeNav.contains(e.target)) {
      dropdown.classList.remove("show");
    }
  });

  // Delete conversation function
  async function deleteConversation(userId) {
    try {
      // Delete the conversation document
      await deleteDoc(doc(db, "users", currentUser.uid, "conversations", userId));
      
      // Delete chat status
      await deleteDoc(doc(db, "users", currentUser.uid, "chatStatus", userId));
      
      // Delete all messages between these users
      const messagesRef = collection(db, "messages");
      const messagesQuery = query(
        messagesRef,
        where("participants", "array-contains", currentUser.uid)
      );
      
      const messagesSnapshot = await getDocs(messagesQuery);
      const deletePromises = [];
      
      messagesSnapshot.forEach(docSnap => {
        const msg = docSnap.data();
        if (msg.participants && msg.participants.includes(userId)) {
          deletePromises.push(deleteDoc(docSnap.ref));
        }
      });
      
      if (deletePromises.length > 0) {
        await Promise.all(deletePromises);
      }
      
      // Refresh the conversation list
      await loadConversationsByTab(activeTab);
      
    } catch (error) {
      console.error("Error deleting conversation:", error);
      alert("Error deleting conversation. Please try again.");
    }
  }

  // Sign out function
  async function handleSignOut() {
    try {
      await signOut(auth);
      window.location.reload();
    } catch (error) {
      console.error("Error signing out:", error);
    }
  }

  // Initialize featured buttons on page load
  updateFeaturedButtons(null);

</script>

</body>
</html>
