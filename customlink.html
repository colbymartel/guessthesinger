<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Your Own Mystery Singer</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
  
    :root{
      --navy:#1e2b38;
      --blue:#3b7bbf;
      --blueDark:#234d7d;
      --sky:#e7f1f9;
      --gold:#ffcb05;
      --green:#3CB371;
      --greenDark:#2e8b57;
      --text:#1f2937;
      --muted:#5b6b7c;
      --border:#dbe6f2;
      --panel:#f7fbff;
      --shadow: 0 10px 25px rgba(17, 24, 39, 0.08);
    }
  
    body{
      font-family:'Poppins', Arial, sans-serif;
      background: linear-gradient(to bottom, #ffffff, var(--sky));
      min-height:100vh;
      color:var(--text);
      display:flex;
      flex-direction:column;
      padding-bottom: 78px; /* room for bottom nav */
    }
  
    /* Header */
    header{
      background: linear-gradient(135deg, var(--blue), var(--blueDark));
      padding: 24px 16px;
      text-align:center;
      color:#fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }
    .header .logo img{
      width: 190px;
      height:auto;
      display:block;
      margin:0 auto;
    }
  
    /* Top Nav */
    nav.top-nav{
      background: var(--navy);
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:#fff;
      width:100%;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .nav-left{ display:flex; align-items:center; gap: 14px; }
    .welcome-nav{ position:relative; }
  
    .welcome-msg{
      cursor:pointer;
      font-weight:700;
      font-size:0.92rem;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .welcome-msg:hover{ background: rgba(255,255,255,0.10); }
  
    .dropdown{
      display:none;
      position:absolute;
      top: 42px;
      left:0;
      background: var(--navy);
      padding: 10px;
      border-radius: 14px;
      flex-direction: column;
      min-width: 170px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.10);
      z-index: 999;
    }
    .dropdown.show{ display:flex; }
    .dropdown a{
      color:#fff;
      text-decoration:none;
      padding: 10px 10px;
      font-weight:600;
      font-size:0.9rem;
      border-radius: 10px;
    }
    .dropdown a:hover{
      background: var(--gold);
      color: var(--navy);
    }
  
    /* Coin */
    .coin-emoji{
      width:22px; height:22px;
      background: radial-gradient(circle at 30% 30%, #ffd700, #f1c40f);
      border-radius:50%;
      box-shadow: 0 2px 0 #cfa300, 0 4px 0 #b8860b, 0 6px 0 #8c6e00;
      position:relative;
      display:inline-block;
    }
    .coin-emoji::after{
      content:"";
      position:absolute;
      top:2px; left:0;
      width:100%; height:100%;
      background: radial-gradient(circle at 30% 30%, #ffe066, transparent);
      border-radius:50%;
    }
    #coinWrapper{
      display:flex; align-items:center; gap:8px;
      font-size:0.95rem;
      font-weight:700;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
  
    /* Main */
    .main{
      flex:1;
      max-width: 980px;
      width:100%;
      margin: 18px auto 0;
      padding: 0 14px 28px;
    }
  
    /* Big card: Duolingo-ish */
    .card{
      background:#fff;
      border-radius: 22px;
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{
      padding: 18px 16px 22px;
    }
    @media (min-width: 768px){
      .card-inner{ padding: 26px 24px 28px; }
    }
  
    /* Hero badge */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-size:0.86rem;
      font-weight:800;
      color: var(--blueDark);
      background: #eaf3ff;
      border: 2px solid #cfe3ff;
      padding: 8px 12px;
      border-radius: 999px;
      margin-bottom: 10px;
    }
    .badge .coin-emoji{
      width:18px;height:18px;
      box-shadow: 0 1px 0 #cfa300, 0 2px 0 #b8860b, 0 3px 0 #8c6e00;
    }
  
    .title{
      font-size: 1.7rem;
      font-weight: 900;
      letter-spacing: -0.02em;
      color: var(--blueDark);
      margin-bottom: 6px;
    }
    .subtitle{
      font-size: 0.98rem;
      color: var(--muted);
      line-height: 1.45;
      margin-bottom: 16px;
    }
  
    /* Steps chips */
    .steps{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .step-chip{
      padding: 7px 11px;
      border-radius: 999px;
      background: #f3f7fd;
      border: 2px solid var(--border);
      font-size: 0.84rem;
      font-weight: 700;
      color: #4c6176;
    }
  
    /* Sections as soft panels */
    .section{
      margin-top: 14px;
      border-radius: 18px;
      border: 2px solid var(--border);
      background: var(--panel);
      padding: 14px 12px;
    }
    @media (min-width: 768px){
      .section{ padding: 16px 14px; }
    }
    .section h2{
      font-size: 1.05rem;
      font-weight: 900;
      color: var(--blueDark);
      margin-bottom: 6px;
    }
    .section p{
      font-size: 0.86rem;
      color: var(--muted);
      margin-bottom: 10px;
      line-height: 1.4;
    }
  
    label.field-label{
      display:block;
      font-size: 0.92rem;
      font-weight: 800;
      color: var(--blueDark);
      margin-bottom: 4px;
    }
    .field-help{
      font-size: 0.82rem;
      color: #6e7f91;
      margin-bottom: 8px;
    }
  
    input[type="text"], input[type="url"], textarea{
      width:100%;
      border-radius: 14px;
      border: 2px solid #cfe0f2;
      padding: 12px 12px;
      font-family:'Poppins', Arial, sans-serif;
      font-size: 0.92rem;
      outline:none;
      background:#fff;
      transition: border-color .15s ease, box-shadow .15s ease, transform .08s ease;
    }
    textarea{ resize:vertical; min-height: 76px; }
    input:focus, textarea:focus{
      border-color: var(--blue);
      box-shadow: 0 0 0 4px rgba(59,123,191,0.18);
    }
    input:active, textarea:active{ transform: translateY(1px); }
  
    /* File input look */
    input[type="file"]{
      width:100%;
      padding: 10px;
      border-radius: 14px;
      border: 2px dashed #cfe0f2;
      background: #fff;
    }
  
    /* Answer mode pills */
    .pill-toggle-group{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 6px;
    }
    .pill-toggle-group label{
      display:inline-flex;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .pill-toggle-group input{ display:none; }
    .pill-toggle-group span{
      padding: 10px 14px;
      border-radius: 999px;
      border: 2px solid #cfe0f2;
      background:#fff;
      font-size: 0.86rem;
      font-weight: 800;
      color: #42566c;
      box-shadow: 0 3px 0 rgba(0,0,0,0.10);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
    }
    .pill-toggle-group input:checked + span{
      background: var(--blue);
      border-color: var(--blueDark);
      color:#fff;
      box-shadow: inset 0 3px 0 rgba(0,0,0,0.25);
      transform: translateY(1px);
    }
  
    .ai-note{
      font-size:0.82rem;
      color:#6e7f91;
      margin-top: 8px;
    }
  
    .ai-button{
      margin-top: 10px;
      border-radius: 999px;
      border: none;
      background: #8b5cf6;
      box-shadow: 0 4px 0 #6d28d9;
      color:#fff;
      font-size: 0.88rem;
      font-weight: 900;
      padding: 10px 14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .ai-button:hover:not(:disabled){
      filter: brightness(1.03);
      transform: translateY(-1px);
      box-shadow: 0 6px 0 #6d28d9;
    }
    .ai-button:active:not(:disabled){
      transform: translateY(2px);
      box-shadow: 0 2px 0 #6d28d9;
    }
    .ai-button:disabled{
      opacity:0.6;
      cursor:not-allowed;
      box-shadow:none;
    }
  
    /* Questions wrapper becomes nicer */
    .questions-wrapper{
      margin-top: 10px;
      max-height: 420px;
      overflow:auto;
      border-radius: 18px;
      border: 2px solid var(--border);
      background: #ffffff;
      padding: 12px;
    }
  
    .question-group-title{
      font-size: 0.95rem;
      font-weight: 900;
      color: var(--blue);
      margin-top: 12px;
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .question-group-title::before{
      content:"";
      width: 10px;
      height: 10px;
      border-radius: 4px;
      background: var(--gold);
      box-shadow: 0 2px 0 #d2a634;
      display:inline-block;
    }
  
    .question-row{
      background:#fff;
      border-radius: 16px;
      padding: 12px 12px 12px;
      margin-bottom: 10px;
      border: 2px solid #e6eef8;
      box-shadow: 0 4px 12px rgba(17, 24, 39, 0.06);
    }
    .question-text{
      font-size: 0.9rem;
      font-weight: 800;
      color: #2a3b52;
      margin-bottom: 8px;
    }
  
    .question-options{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-bottom: 8px;
    }
    .question-options label{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
    }
    .question-options input{ display:none; }
  
    .answer-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 9px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 900;
      min-width: 74px;
      background:#eaf3ff;
      border: 2px solid #cfe3ff;
      color: var(--blueDark);
      box-shadow: 0 3px 0 rgba(0,0,0,0.12);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .question-options label:hover .answer-pill{
      filter: brightness(0.98);
      transform: translateY(-1px);
      box-shadow: 0 5px 0 rgba(0,0,0,0.14);
    }
  
    /* Selected states */
    .question-options input[value="yes"]:checked + .answer-pill{
      background: var(--green);
      border-color: var(--greenDark);
      color:#fff;
      box-shadow: inset 0 3px 0 rgba(0,0,0,0.25);
      transform: translateY(1px);
    }
    .question-options input[value="no"]:checked + .answer-pill{
      background:#e74c3c;
      border-color:#c0392b;
      color:#fff;
      box-shadow: inset 0 3px 0 rgba(0,0,0,0.25);
      transform: translateY(1px);
    }
    .question-options input[value="skip"]:checked + .answer-pill{
      background:#f1c40f;
      border-color:#d4ac0d;
      color:#4a3d00;
      box-shadow: inset 0 3px 0 rgba(0,0,0,0.25);
      transform: translateY(1px);
    }
  
    .question-custom{
      font-size: 0.78rem;
      color:#6e7f91;
      margin-bottom: 6px;
    }
    .question-row textarea{
      min-height: 56px;
      font-size: 0.86rem;
    }
  
    /* Hints grid */
    .hints-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 600px){
      .hints-grid{ grid-template-columns: repeat(3, 1fr); }
    }
  
    /* Submit area */
    .submit-row{
      margin-top: 8px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
  
    .primary-btn{
      width:100%;
      height: 54px;
      border-radius: 18px;
      border: 2px solid rgba(0,0,0,0.08);
      background: var(--green);
      box-shadow: 0 6px 0 var(--greenDark);
      color:#fff;
      font-size: 1.05rem;
      font-weight: 950;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .primary-btn:hover:not(:disabled){
      filter: brightness(1.02);
      transform: translateY(-2px);
      box-shadow: 0 8px 0 var(--greenDark);
    }
    .primary-btn:active:not(:disabled){
      transform: translateY(3px);
      box-shadow: 0 3px 0 var(--greenDark);
    }
    .primary-btn:disabled{
      opacity: 0.7;
      cursor:not-allowed;
      box-shadow:none;
    }
  
    .status-message{ font-size: 0.92rem; font-weight: 700; }
    .status-message.success{ color:#1f7a47; }
    .status-message.error{ color:#c0392b; }
  
    .share-link-box{
      margin-top: 8px;
      padding: 12px;
      border-radius: 16px;
      background: #ffffff;
      border: 2px dashed #b6cbe6;
      font-size: 0.88rem;
      display:none;
    }
    .share-link-row{
      display:flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap:wrap;
    }
    .share-link-row input{
      flex: 1;
      min-width: 220px;
    }
    .copy-btn{
      border-radius: 14px;
      border: none;
      padding: 10px 14px;
      font-size: 0.9rem;
      font-weight: 900;
      background: var(--blue);
      color:#fff;
      cursor:pointer;
      box-shadow: 0 4px 0 var(--blueDark);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .copy-btn:hover{
      filter: brightness(1.02);
      transform: translateY(-1px);
      box-shadow: 0 6px 0 var(--blueDark);
    }
    .copy-btn:active{
      transform: translateY(3px);
      box-shadow: 0 3px 0 var(--blueDark);
    }
  
    /* Bottom nav */
    .bottom-nav{
      position: fixed;
      bottom: 0;
      width:100%;
      background: var(--navy);
      display:flex;
      justify-content: space-around;
      align-items:center;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      z-index: 999;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.12);
    }
    .bottom-nav .nav-item{
      color:#fff;
      text-align:center;
      text-decoration:none;
      font-size: 12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 3px;
      padding: 6px 10px;
      border-radius: 14px;
      transition: background .12s ease, color .12s ease;
    }
    .bottom-nav .nav-item i,
    .bottom-nav .nav-item img{
      font-size: 20px;
      width: 24px;
      height: 24px;
      object-fit: contain;
    }
    .bottom-nav .nav-item:hover{
      color: var(--gold);
      background: rgba(255,255,255,0.06);
    }
  
    /* Scrollbars */
    ::-webkit-scrollbar{ width: 8px; height:8px; }
    ::-webkit-scrollbar-track{ background: #eef3f8; border-radius: 10px; }
    ::-webkit-scrollbar-thumb{ background: #b6cbe6; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover{ background: #7b91b0; }
  </style>
  
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="logo">
      <img src="../images/SingerLogo.png" alt="Guess the Singer Logo" loading="lazy">
    </div>
  </header>

  <!-- TOP NAV -->
  <nav class="top-nav">
    <div class="nav-left">
      <div class="welcome-nav">
        <div id="welcomeMessage" class="welcome-msg">Welcome, Anonymous</div>
        <div id="dropdownMenu" class="dropdown"></div>
      </div>

      <div id="coinWrapper">
        <div class="coin-emoji"></div>
        <span id="coinCount" style="font-weight:bold;">0</span>
      </div>
    </div>
    <div></div>
  </nav>

  <!-- MAIN -->
  <main class="main">
    <section class="card">
      <div class="card-inner">
          <div class="badge">
        <div class="coin-emoji"></div>
        <span>Create a custom challenge for your friends</span>
      </div>

      <h1 class="title">Build Your Own "Guess the Singer" Game"</h1>
      <p class="subtitle">
        Pick a singer, choose hints, and set up answers. We‚Äôll give you a shareable link that
        plays just like the daily game.
      </p>

      <div class="steps">
        <div class="step-chip">1. Choose singer & image</div>
        <div class="step-chip">2. Add hints</div>
        <div class="step-chip">3. Answer the question bank (or use AI)</div>
        <div class="step-chip">4. Share your link</div>
      </div>

      <!-- SINGER + IMAGE -->
      <div class="section">
        <h2>1. Mystery Singer</h2>
        <p>Who do you want your friends to guess?</p>
        <input type="text" id="artistName" placeholder="Ex: Taylor Swift, Bad Bunny, Drake">
<br><br>
        <label class="field-label" for="artistImageFile">Singer photo (optional)</label>
        <div class="field-help">Pick a photo from your camera roll.</div>
        
        <input
          type="file"
          id="artistImageFile"
          accept="image/*"
          capture="environment"
        />
        
        <div id="imagePreviewWrap" style="margin-top:10px; display:none;">
          <div class="field-help" style="margin-bottom:6px;">Preview:</div>
          <img id="imagePreview" alt="Singer preview" style="max-width:180px;width:100%;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.12);object-fit:cover;">
        </div>
        
      </div>

      <!-- HINTS -->
      <div class="section">
        <h2>2. Hints</h2>
        <p>These show up in the hint modal.</p>
        <div class="hints-grid">
          <div class="hint-box-input">
            <label class="field-label" for="hint1">Hint 1</label>
            <textarea id="hint1" placeholder="Ex: This artist is from New York."></textarea>
          </div>
          <div class="hint-box-input">
            <label class="field-label" for="hint2">Hint 2</label>
            <textarea id="hint2" placeholder="Ex: They were recently engaged to a NFL player."></textarea>
          </div>
          <div class="hint-box-input">
            <label class="field-label" for="hint3">Hint 3</label>
            <textarea id="hint3" placeholder="Ex: We saw this artist in concert."></textarea>
          </div>
          <div class="hint-box-input">
            <label class="field-label" for="hint4">Hint 4 (optional)</label>
            <textarea id="hint4"></textarea>
          </div>
          <div class="hint-box-input">
            <label class="field-label" for="hint5">Hint 5 (optional)</label>
            <textarea id="hint5"></textarea>
          </div>
        </div>
      </div>

      <!-- ANSWER MODE -->
      <div class="section">
        <h2>3. How should answers be filled?</h2>
        <p>We use the same yes/no question bank from the daily game.</p>

        <label class="field-label">Answer mode</label>
        <div class="pill-toggle-group">
          <label>
            <input type="radio" name="answerMode" value="manual" checked>
            <span>I'll answer manually</span>
          </label>
          <label>
            <input type="radio" name="answerMode" value="ai">
            <span>Use AI to suggest answers</span>
          </label>
        </div>
        <p class="ai-note">
          ‚úÖ AI can make mistakes. Check over answers before creating the link.
        </p>

        <button id="aiFillButton" class="ai-button" disabled>
          <i class="fas fa-wand-magic-sparkles"></i>
          Use AI to suggest answers
        </button>
        <div id="aiStatus" class="ai-note"></div>
      </div>

      <!-- QUESTIONS BANK -->
      <div class="section">
        <h2>4. Question Bank</h2>
        <p>
          For each question, choose Yes / No / Skip and (optionally) customize the sentence that appears
          when your friend asks it.
        </p>

        <div class="questions-wrapper" id="questionsContainer"></div>
      </div>

      <!-- SUBMIT -->
      <div class="section">
        <h2>5. Create your link</h2>
        <p>We‚Äôll save this challenge and give you a URL that opens a Day-style game with your singer.</p>

        <div class="submit-row">
          <button id="createChallengeButton" class="primary-btn">
            Create Challenge & Get Link
          </button>
          <div id="statusMessage" class="status-message"></div>

          <div id="shareLinkBox" class="share-link-box">
            <div><strong>Your challenge link:</strong></div>
            <div class="share-link-row">
              <input type="text" id="shareLinkInput" readonly>
              <button id="copyLinkButton" class="copy-btn">Copy</button>
            </div>
            <div style="margin-top:4px;font-size:0.8rem;color:#6a7a8f;">
              Send this to friends ‚Äì it will load your custom mystery singer game.
            </div>
          </div>
        </div>
      </div>
      </div>
    </section>
  </main>

  <!-- BOTTOM NAV -->
  <footer class="bottom-nav">
    <a href="/profile.html" class="nav-item">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
    <a href="/games.html" class="nav-item">
      <i class="fas fa-gamepad"></i>
      <span>Games</span>
    </a>
    <a href="/memory-leaderboard.html" class="nav-item">
      <i class="fas fa-trophy"></i>
      <span>Leaderboards</span>
    </a>
    <a href="/rewards.html" class="nav-item">
      <i class="fas fa-gift"></i>
      <span>Rewards</span>
    </a>
  </footer>

  <!-- LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD36qSJ8YAPc3A4FL9jlBGlpiWwj530SPQ",
      authDomain: "guessthesinger10.firebaseapp.com",
      projectId: "guessthesinger10",
      storageBucket: "guessthesinger10.appspot.com",
      messagingSenderId: "97201023235",
      appId: "1:97201023235:web:ab111d9acb43ef7d4be136"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    const storage = getStorage(app);

    const welcomeEl    = document.getElementById("welcomeMessage");
    const dropdownMenu = document.getElementById("dropdownMenu");
    const coinDisplay  = document.getElementById("coinCount");

    const artistNameInput      = document.getElementById("artistName");
const artistImageFileInput = document.getElementById("artistImageFile");
const imagePreviewWrap = document.getElementById("imagePreviewWrap");
const imagePreview = document.getElementById("imagePreview");

artistImageFileInput.addEventListener("change", () => {
  const file = artistImageFileInput.files?.[0];
  if (!file) {
    imagePreviewWrap.style.display = "none";
    return;
  }
  const url = URL.createObjectURL(file);
  imagePreview.src = url;
  imagePreviewWrap.style.display = "block";
});

    const hintInputs = [
      document.getElementById("hint1"),
      document.getElementById("hint2"),
      document.getElementById("hint3"),
      document.getElementById("hint4"),
      document.getElementById("hint5")
    ];

    const questionsContainer   = document.getElementById("questionsContainer");
    const createButton         = document.getElementById("createChallengeButton");
    const statusMessage        = document.getElementById("statusMessage");

    const aiFillButton         = document.getElementById("aiFillButton");
    const aiStatus             = document.getElementById("aiStatus");
    const shareLinkBox         = document.getElementById("shareLinkBox");
    const shareLinkInput       = document.getElementById("shareLinkInput");
    const copyLinkButton       = document.getElementById("copyLinkButton");

    let currentUserUid = null;

    // ---- Question bank ----
    const QUESTION_BANK = [
      // General
      { key: "Is this a male artist?",           label: "Is this a male artist?",           group: "General" },
      { key: "Is this a female artist?",         label: "Is this a female artist?",         group: "General" },
      { key: "Are they still alive?",            label: "Are they still alive?",            group: "General" },
      { key: "Are they over 30 years old?",      label: "Are they over 30 years old?",      group: "General" },
      { key: "Are they over 40 years old?",      label: "Are they over 40 years old?",      group: "General" },
      { key: "Are they over 50 years old?",      label: "Are they over 50 years old?",      group: "General" },
      { key: "Did they debut before 2000?",      label: "Did they debut before 2000?",      group: "General" },
      { key: "Did they debut before 2010?",      label: "Did they debut before 2010?",      group: "General" },
      { key: "Did they debut before 2020?",      label: "Did they debut before 2020?",      group: "General" },
      { key: "Album release in last 2 years?",   label: "Did they release an album within the last 2 years?", group: "General" },
      { key: "Are they currently on tour?",      label: "Are they currently on tour?",      group: "General" },
      { key: "Are they currently married?",      label: "Are they currently married?",      group: "General" },
      { key: "Were they ever divorced?",         label: "Were they ever divorced?",         group: "General" },
      { key: "Do they identify as LGBTQ+?",      label: "Do they identify as LGBTQ+?",      group: "General" },

      // Geographic
      { key: "Were they born in North America?", label: "Were they born in North America?", group: "Geographic" },
      { key: "Were they born in the United States?", label: "Were they born in the United States?", group: "Geographic" },
      { key: "Were they born in Canada?",        label: "Were they born in Canada?",        group: "Geographic" },
      { key: "Were they born in Europe?",        label: "Were they born in Europe?",        group: "Geographic" },
      { key: "Were they born in Asia?",          label: "Were they born in Asia?",          group: "Geographic" },
      { key: "Were they born in South America?", label: "Were they born in South America?", group: "Geographic" },
      { key: "Were they born in Australia?",     label: "Were they born in Australia?",     group: "Geographic" },
      { key: "Were they born in Africa?",        label: "Were they born in Africa?",        group: "Geographic" },

      // Background
      { key: "Are they of African descent?",     label: "Are they of African descent?",     group: "Background" },
      { key: "Are they of European descent?",    label: "Are they of European descent?",    group: "Background" },
      { key: "Are they of Latin American descent?", label: "Are they of Latin American descent?", group: "Background" },
      { key: "Are they of Asian descent?",       label: "Are they of Asian descent?",       group: "Background" },
      { key: "Are they of mixed ethnicities?",   label: "Are they of mixed ethnicities?",   group: "Background" },

      // Music Style
      { key: "Different languages?", label: "Do they perform songs in different languages?", group: "Music Style" },
      { key: "Spanish music?",       label: "Do they perform Spanish music?",                 group: "Music Style" },
      { key: "Pop music?",           label: "Do they perform pop music?",                    group: "Music Style" },
      { key: "Rap music?",           label: "Do they perform rap music?",                    group: "Music Style" },
      { key: "R&B music?",           label: "Do they perform R&B music?",                    group: "Music Style" },
      { key: "Rock music?",          label: "Do they perform rock music?",                   group: "Music Style" },
      { key: "Country music?",       label: "Do they perform country music?",                group: "Music Style" },
      { key: "Jazz music?",          label: "Do they perform jazz music?",                   group: "Music Style" },
      { key: "Party music?",         label: "Do they perform party music?",                  group: "Music Style" },
      { key: "Sad music?",           label: "Do they perform sad music?",                    group: "Music Style" },

      // Career / Popularity
      { key: "Also an actor?",           label: "Are they also an actor?",                                group: "Career & Popularity" },
      { key: "Disney or Nick?",         label: "Were they ever on Disney Channel or Nickelodeon?",       group: "Career & Popularity" },
      { key: "Singing competition?",    label: "Have they ever competed in a TV singing competition?",   group: "Career & Popularity" },
      { key: "Won a Grammy?",           label: "Have they ever won a Grammy?",                           group: "Career & Popularity" },
      { key: "Super Bowl?",             label: "Have they ever performed at a Super Bowl halftime show?",group: "Career & Popularity" },
      { key: "Coachella?",              label: "Have they ever performed at Coachella?",                group: "Career & Popularity" },
      { key: "Song over one billion streams?", label: "Do they have song(s) with over 1 Billion Spotify streams?", group: "Career & Popularity" },
      { key: "20M listeners?",          label: "Do they have more than 20M monthly Spotify listeners?", group: "Career & Popularity" },
      { key: "50M listeners?",          label: "Do they have more than 50M monthly Spotify listeners?", group: "Career & Popularity" },
      { key: "Ever in a band?",         label: "Are/were they ever in a band?",                         group: "Career & Popularity" },

      // Name & Appearance
      { key: "Dark hair?",         label: "Do they have black or brown hair?",           group: "Name & Appearance" },
      { key: "Blond hair?",        label: "Do they have blond hair?",                    group: "Name & Appearance" },
      { key: "Over 5.5ft tall?",   label: "Are they over 5 1/2 feet tall?",              group: "Name & Appearance" },
      { key: "Over 6ft tall?",     label: "Are they over 6 feet tall?",                  group: "Name & Appearance" },
      { key: "Tattoos?",           label: "Do they have visible tattoos?",               group: "Name & Appearance" },
      { key: "Glasses?",           label: "Do they wear glasses?",                       group: "Name & Appearance" },
      { key: "Birth name?",        label: "Do they go by their birth name?",             group: "Name & Appearance" },
      { key: "One-word name?",     label: "Do they go by one word?",                     group: "Name & Appearance" },
      { key: "Two-word name?",     label: "Do they go by two words?",                    group: "Name & Appearance" },
      { key: "Name starts A‚ÄìM?",   label: "Does their name start with a letter A‚ÄìM?",    group: "Name & Appearance" }
    ];

    function slugifyArtist(name) {
  return (name || "")
    .trim()
    .toLowerCase()
    .replace(/['‚Äô]/g, "")       // remove apostrophes
    .replace(/[^a-z0-9]+/g, "-")// non-alnum -> dash
    .replace(/^-+|-+$/g, "");   // trim dashes
}

function defaultArtistImagePath(artistName) {
  const slug = slugifyArtist(artistName);
  if (!slug) return "../images/default-singer.jpg";
  return `../images/${slug}.jpg`;
}

async function uploadArtistImageAndGetUrl(file, artistName, creatorUid) {
  const slug = slugifyArtist(artistName) || "unknown";
  const safeUid = creatorUid || "anon";
  const fileExt = (file.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g, "");
  const filePath = `customChallengeImages/${safeUid}/${Date.now()}_${slug}.${fileExt}`;

  const imageRef = ref(storage, filePath);
  await uploadBytes(imageRef, file, { contentType: file.type || "image/jpeg" });
  return await getDownloadURL(imageRef);
}

    // map key -> label for clean sentence building
    const KEY_TO_LABEL = Object.fromEntries(QUESTION_BANK.map(q => [q.key, q.label]));

    // --- Gender-neutral, no-name, always "Yes/No, they ..." sentence builder ---
    function buildNeutralAnswer(label, isYes) {
      if (isYes === null || isYes === undefined) return "";

      const q = (label || "").trim();

      // Normalize: strip trailing "?"
      const core = q.endsWith("?") ? q.slice(0, -1) : q;

      // Helper: ensures ending punctuation.
      const end = (s) => (/[.!]$/.test(s.trim()) ? s.trim() : (s.trim() + "."));

      // Patterns (most of your bank is covered here)
      if (/^Is this a /i.test(core)) {
        const rest = core.replace(/^Is this a /i, "a ");
        return isYes ? end(`Yes, they are ${rest}`) : end(`No, they are not ${rest}`);
      }

      if (/^Are they /i.test(core)) {
        const rest = core.replace(/^Are they /i, "");
        // rest might already include "over 30 years old" etc.
        return isYes ? end(`Yes, they are ${rest}`) : end(`No, they are not ${rest}`);
      }

      if (/^Were they /i.test(core)) {
        const rest = core.replace(/^Were they /i, "");
        return isYes ? end(`Yes, they were ${rest}`) : end(`No, they were not ${rest}`);
      }

      if (/^Do they /i.test(core)) {
        const rest = core.replace(/^Do they /i, "");
        return isYes ? end(`Yes, they do ${rest}`) : end(`No, they do not ${rest}`);
      }

      if (/^Does their /i.test(core)) {
        const rest = core.replace(/^Does their /i, "their ");
        return isYes ? end(`Yes, ${rest}`) : end(`No, ${rest.replace(/^their /i, "their ")} not`);
      }

      if (/^Did they /i.test(core)) {
        const rest = core.replace(/^Did they /i, "");
        return isYes ? end(`Yes, they did ${rest}`) : end(`No, they did not ${rest}`);
      }

      if (/^Have they /i.test(core)) {
        const rest = core.replace(/^Have they /i, "");
        return isYes ? end(`Yes, they have ${rest}`) : end(`No, they have not ${rest}`);
      }

      // fallback (safe and neutral)
      return isYes ? end("Yes, they do.") : end("No, they do not.");
    }

    // Render question UI
    function renderQuestions() {
      const groups = {};
      QUESTION_BANK.forEach(q => {
        if (!groups[q.group]) groups[q.group] = [];
        groups[q.group].push(q);
      });

      questionsContainer.innerHTML = "";
      let questionIndex = 0;

      Object.keys(groups).forEach(groupName => {
        const title = document.createElement("div");
        title.className = "question-group-title";
        title.textContent = groupName + " Questions";
        questionsContainer.appendChild(title);

        groups[groupName].forEach(q => {
          const row = document.createElement("div");
          row.className = "question-row";
          row.dataset.key = q.key;

          const text = document.createElement("div");
          text.className = "question-text";
          text.textContent = q.label;
          row.appendChild(text);

          const opts = document.createElement("div");
          opts.className = "question-options";

          ["yes", "no", "skip"].forEach(val => {
            const optLabel = document.createElement("label");
            const input = document.createElement("input");
            input.type = "radio";
            input.name = "q_" + questionIndex;
            input.value = val;

            const span = document.createElement("span");
            span.textContent = val === "yes" ? "Yes" : (val === "no" ? "No" : "Skip");
            span.className = "answer-pill answer-" + (val === "yes" ? "yes" : val === "no" ? "no" : "skip");

            optLabel.appendChild(input);
            optLabel.appendChild(span);
            opts.appendChild(optLabel);
          });

          row.appendChild(opts);

          const customLabel = document.createElement("div");
          customLabel.className = "question-custom";
          customLabel.textContent = "Optional custom answer (otherwise we auto-generate: ‚ÄúYes/No, they ‚Ä¶‚Äù):";
          row.appendChild(customLabel);

          const ta = document.createElement("textarea");
          ta.placeholder = "Ex: Yes, they are over 30 years old.";
          ta.dataset.key = q.key;
          row.appendChild(ta);

          questionsContainer.appendChild(row);

          questionIndex++;
        });
      });
    }

    renderQuestions();

    // --- Auth handling ---
    function setAnonymousUI() {
      if (welcomeEl) welcomeEl.textContent = "Welcome, Anonymous";
      if (coinDisplay) coinDisplay.textContent = "0";
      if (dropdownMenu) {
        dropdownMenu.innerHTML = `
          <a href="/login.html">Log In</a>
          <a href="/signup.html">Create Profile</a>
        `;
      }
      currentUserUid = null;
    }

    onAuthStateChanged(auth, async (user) => {
      dropdownMenu.innerHTML = "";
      if (!user) {
        setAnonymousUI();
        return;
      }

      currentUserUid = user.uid;
      welcomeEl.textContent = `Welcome, ${user.displayName || "Player"}`;

      dropdownMenu.innerHTML = `
        <a href="/profile.html">Profile</a>
        <a href="#" id="logoutBtn">Log Out</a>
      `;

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          setAnonymousUI();
        });
      }
    });

    if (welcomeEl && dropdownMenu) {
      welcomeEl.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle("show");
      });
      document.addEventListener("click", (e) => {
        if (!dropdownMenu.contains(e.target) && e.target !== welcomeEl) {
          dropdownMenu.classList.remove("show");
        }
      });
    }

    // --- Answer mode + AI button toggle ---
    const answerModeInputs = document.querySelectorAll('input[name="answerMode"]');
    function updateAiButtonState() {
      const mode = document.querySelector('input[name="answerMode"]:checked')?.value;
      aiFillButton.disabled = mode !== "ai";
    }
    answerModeInputs.forEach(r => r.addEventListener("change", updateAiButtonState));
    updateAiButtonState();

    // --- Collect question answers from the form ---
    function collectQuestionAnswers() {
      const rows = questionsContainer.querySelectorAll(".question-row");
      const answers = {};

      rows.forEach(row => {
        const key = row.dataset.key;
        const selected = row.querySelector('input[type="radio"]:checked');
        const custom = row.querySelector('textarea').value.trim();

        let isYes = null;
        if (selected) {
          if (selected.value === "yes") isYes = true;
          else if (selected.value === "no") isYes = false;
        }

        // Default: auto-generate gender-neutral sentence that starts with Yes/No
        let answerText = "";
        if (custom) {
          answerText = custom; // user override
        } else if (isYes === true || isYes === false) {
          answerText = buildNeutralAnswer(KEY_TO_LABEL[key], isYes);
        } else {
          answerText = ""; // skip or unanswered
        }

        answers[key] = { isYes, answerText };
      });

      return answers;
    }

    // --- AI fill: still calls your endpoint, but we DO NOT use its wording.
    // We only use info.isYes and we generate safe, gender-neutral text that never includes the artist name.
    aiFillButton.addEventListener("click", async () => {
      const artistName = artistNameInput.value.trim();
      if (!artistName) {
        aiStatus.textContent = "Add a singer name first so AI knows who to use.";
        return;
      }

      aiStatus.textContent = "Asking AI for suggestions...";
      aiFillButton.disabled = true;

      try {
        const res = await fetch("https://generateanswers-csb4zmthiq-uc.a.run.app", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ artistName, questionKeys: QUESTION_BANK.map(q => q.key) })
        });

        const rawText = await res.text();
        if (!res.ok) {
          console.error("AI endpoint failed:", res.status, rawText);
          aiStatus.textContent = `AI failed (${res.status}). Check console for details.`;
          throw new Error(rawText);
        }

        const data = JSON.parse(rawText);
        if (!data || !data.answers) throw new Error("No answers returned");

        const rows = questionsContainer.querySelectorAll(".question-row");
        rows.forEach(row => {
          const key = row.dataset.key;
          const info = data.answers[key];
          if (!info) return;

          const yesRadio  = row.querySelector('input[value="yes"]');
          const noRadio   = row.querySelector('input[value="no"]');
          const skipRadio = row.querySelector('input[value="skip"]');

          if (info.isYes === true && yesRadio) yesRadio.checked = true;
          else if (info.isYes === false && noRadio) noRadio.checked = true;
          else if (skipRadio) skipRadio.checked = true;

          if (info.isYes === true || info.isYes === false) {
            row.querySelector('textarea').value = buildNeutralAnswer(KEY_TO_LABEL[key], info.isYes);
          } else {
            row.querySelector('textarea').value = "";
          }
        });

        aiStatus.textContent = "AI suggestions applied.";
      } catch (err) {
        console.error(err);
        aiStatus.textContent = "AI failed ‚Äì you can still fill answers manually.";
      } finally {
        aiFillButton.disabled = false;
      }
    });

    // --- Create challenge ---
    createButton.addEventListener("click", async () => {
      statusMessage.textContent = "";
      statusMessage.className = "status-message";

      const artistName = artistNameInput.value.trim();
      if (!artistName) {
        statusMessage.textContent = "Please enter a singer name.";
        statusMessage.classList.add("error");
        return;
      }

      let imageUrl = null;

// 1) If user picked a file, upload it & use that URL
const file = artistImageFileInput.files?.[0];
if (file) {
  try {
    imageUrl = await uploadArtistImageAndGetUrl(file, artistName, currentUserUid);
  } catch (e) {
    console.error("Image upload failed:", e);
    statusMessage.textContent = "Image upload failed. Try again or skip the photo.";
    statusMessage.classList.add("error");
    createButton.disabled = false;
    createButton.textContent = "Create Challenge & Get Link";
    return;
  }
}

// 2) If no upload, store null (customgame will compute ../images/<artist>.jpg)

      const hints = hintInputs.map(el => el.value.trim()).filter(Boolean);
      if (!hints.length) {
        statusMessage.textContent = "Please add at least one hint.";
        statusMessage.classList.add("error");
        return;
      }

      const questionAnswers = collectQuestionAnswers();

      createButton.disabled = true;
      createButton.textContent = "Creating challenge...";

      try {
        const docRef = await addDoc(collection(db, "customChallenges"), {
          artistName,
          imageUrl,
          hints,
          questionAnswers,
          maxQuestions: 15,
          creatorUid: currentUserUid || null,
          createdAt: serverTimestamp()
        });

        const url = `${window.location.origin}/customgame.html?id=${docRef.id}`;
        shareLinkInput.value = url;
        shareLinkBox.style.display = "block";

        statusMessage.textContent = "Challenge created! Copy your link below.";
        statusMessage.classList.remove("error");
        statusMessage.classList.add("success");
      } catch (err) {
        console.error("Error creating challenge:", err);
        statusMessage.textContent = "Something went wrong creating your challenge. Please try again.";
        statusMessage.classList.remove("success");
        statusMessage.classList.add("error");
      } finally {
        createButton.disabled = false;
        createButton.textContent = "Create Challenge & Get Link";
      }
    });

    // --- Copy link ---
    copyLinkButton.addEventListener("click", async () => {
      const link = shareLinkInput.value;
      if (!link) return;
      try {
        await navigator.clipboard.writeText(link);
        alert("Link copied! Send it to your friends üî•");
      } catch {
        alert("Couldn't copy automatically. Long-press or highlight to copy.");
      }
    });
  </script>
</body>
</html>
