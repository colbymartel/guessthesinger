<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feature Submissions - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-V74WPZR1FC"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-V74WPZR1FC');
  </script>

  <style>
    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(to bottom, #ffffff, #e7f1f9);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    header {
      background: linear-gradient(135deg, #3b7bbf, #234d7d);
      padding: 30px 20px;
      text-align: center;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .header .logo img {
      width: 150px;
      height: auto;
      margin: 0 auto;
      display: block;
    }
    
    .admin-title {
      font-size: 2rem;
      font-weight: bold;
      margin: 20px 0 10px 0;
    }
    
    .admin-subtitle {
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 30px;
    }
    
    .container {
      max-width: 1400px;
      width: 95%;
      margin: 30px auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .stats-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 25px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #3b7bbf;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #666;
      font-weight: 500;
    }
    
    .controls-section {
      padding: 20px 25px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    
    .search-box {
      flex: 1;
      min-width: 200px;
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: 'Fredoka', sans-serif;
      font-size: 14px;
    }
    
    .filter-select {
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: 'Fredoka', sans-serif;
      font-size: 14px;
      background: white;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-family: 'Fredoka', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b7bbf, #234d7d);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 123, 191, 0.3);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .table-container {
      overflow-x: auto;
      max-height: 70vh;
    }
    
    .submissions-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .submissions-table th,
    .submissions-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
      vertical-align: top;
    }
    
    .submissions-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .submissions-table tr:hover {
      background: #f8f9fa;
    }
    
    .submissions-table .photo-cell {
      text-align: center;
      width: 80px;
    }
    
    .user-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .user-photo:hover {
      transform: scale(1.1);
    }
    
    .download-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .download-btn:hover {
      background: #218838;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-approved {
      background: #d4edda;
      color: #155724;
    }
    
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    
    .pagination {
      padding: 20px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
    }
    
    .pagination button {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Fredoka', sans-serif;
    }
    
    .pagination button:hover:not(:disabled) {
      background: #f8f9fa;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b7bbf;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    
    .modal-content {
      margin: 5% auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: black;
    }
    
    .modal img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
    }
    
    @media (max-width: 768px) {
      .controls-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        min-width: unset;
      }
      
      .submissions-table {
        font-size: 12px;
      }
      
      .submissions-table th,
      .submissions-table td {
        padding: 8px;
      }
      
      .user-photo {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="logo">
      <a href="/index.html">
        <img src="images/SingerLogo.png" alt="Guess the Singer Logo">
      </a>
    </div>
    <h1 class="admin-title">ðŸŒŸ Feature Submissions</h1>
    <p class="admin-subtitle">Manage daily game feature requests from users</p>
  </header>

  <div class="container">
    <div class="stats-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalSubmissions">0</div>
          <div class="stat-label">Total Submissions</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingSubmissions">0</div>
          <div class="stat-label">Pending Review</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="approvedSubmissions">0</div>
          <div class="stat-label">Approved</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="uniqueArtists">0</div>
          <div class="stat-label">Unique Artists</div>
        </div>
      </div>
    </div>

    <div class="controls-section">
      <input type="text" 
             id="searchBox" 
             class="search-box" 
             placeholder="Search by name, email, or artist...">
      
      <select id="statusFilter" class="filter-select">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
      
      <div style="margin-left: auto; display: flex; gap: 10px;">
        <button id="refreshBtn" class="btn btn-secondary">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button id="exportBtn" class="btn btn-primary">
          <i class="fas fa-download"></i> Export CSV
        </button>
      </div>
    </div>

    <div class="table-container">
      <table class="submissions-table" id="submissionsTable">
        <thead>
          <tr>
            <th>Photo</th>
            <th>Name</th>
            <th>Email</th>
            <th>Social Handle</th>
            <th>Favorite Artist</th>
            <th>Why Favorite</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="submissionsTableBody">
          <tr>
            <td colspan="9" class="loading">
              <div class="loading-spinner"></div>
              <p>Loading feature submissions...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" id="pagination" style="display: none;">
      <button id="prevBtn" onclick="changePage(-1)">Previous</button>
      <span id="pageInfo">Page 1 of 1</span>
      <button id="nextBtn" onclick="changePage(1)">Next</button>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <img id="modalImage" src="" alt="User Photo">
      <div id="modalDetails"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
    import { getFirestore, collection, getDocs, query, orderBy, limit, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBs6Yw6qcL_fJEOi_ZPJLFtWPdEgmvYPHo",
      authDomain: "guessthesinger-ce011.firebaseapp.com",
      projectId: "guessthesinger-ce011",
      storageBucket: "guessthesinger-ce011.appspot.com",
      messagingSenderId: "1093504132625",
      appId: "1:1093504132625:web:bdccbd30a3c5e66c9b2f3c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let allSubmissions = [];
    let filteredSubmissions = [];
    let currentPage = 1;
    const itemsPerPage = 20;

    // DOM elements (will be initialized after DOM loads)
    let searchBox, statusFilter, refreshBtn, exportBtn, submissionsTableBody, pagination, modal, modalImage, modalDetails;

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // DOM elements
      searchBox = document.getElementById('searchBox');
      statusFilter = document.getElementById('statusFilter');
      refreshBtn = document.getElementById('refreshBtn');
      exportBtn = document.getElementById('exportBtn');
      submissionsTableBody = document.getElementById('submissionsTableBody');
      pagination = document.getElementById('pagination');
      modal = document.getElementById('imageModal');
      modalImage = document.getElementById('modalImage');
      modalDetails = document.getElementById('modalDetails');

      // Event listeners
      searchBox.addEventListener('input', filterSubmissions);
      statusFilter.addEventListener('change', filterSubmissions);
      refreshBtn.addEventListener('click', loadFeatureSubmissions);
      exportBtn.addEventListener('click', exportToCSV);

      // Modal event listeners
      document.querySelector('.close').addEventListener('click', () => {
        modal.style.display = 'none';
      });

      window.addEventListener('click', (event) => {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });

      // Load submissions after DOM is ready
      loadFeatureSubmissions();
    });



    async function loadFeatureSubmissions() {
      try {
        showLoading();
        
        const submissionsRef = collection(db, "featureSubmissions");
        const q = query(submissionsRef, orderBy("timestamp", "desc"), limit(1000));
        const snapshot = await getDocs(q);
        
        allSubmissions = snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            userName: data.userName || 'N/A',
            userEmail: data.userEmail || 'N/A',
            socialHandle: data.socialHandle || '',
            userPhotoURL: data.userPhotoURL || '',
            favoriteArtist: data.favoriteArtist || 'N/A',
            whyFavorite: data.whyFavorite || '',
            status: data.status || 'pending',
            timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
            userId: data.userId || ''
          };
        });

        updateStats();
        filterSubmissions();
        
      } catch (error) {
        console.error('Error loading feature submissions:', error);
        showError('Failed to load submissions. Please try again.');
      }
    }

    function updateStats() {
      const total = allSubmissions.length;
      const pending = allSubmissions.filter(s => s.status === 'pending').length;
      const approved = allSubmissions.filter(s => s.status === 'approved').length;
      const uniqueArtists = new Set(allSubmissions.map(s => s.favoriteArtist.toLowerCase())).size;

      document.getElementById('totalSubmissions').textContent = total;
      document.getElementById('pendingSubmissions').textContent = pending;
      document.getElementById('approvedSubmissions').textContent = approved;
      document.getElementById('uniqueArtists').textContent = uniqueArtists;
    }

    function filterSubmissions() {
      const searchTerm = searchBox.value.toLowerCase();
      const statusTerm = statusFilter.value;

      filteredSubmissions = allSubmissions.filter(submission => {
        const matchesSearch = !searchTerm || 
          submission.userName.toLowerCase().includes(searchTerm) ||
          submission.userEmail.toLowerCase().includes(searchTerm) ||
          submission.favoriteArtist.toLowerCase().includes(searchTerm) ||
          submission.socialHandle.toLowerCase().includes(searchTerm);

        const matchesStatus = !statusTerm || submission.status === statusTerm;

        return matchesSearch && matchesStatus;
      });

      currentPage = 1;
      displaySubmissions();
    }

    function displaySubmissions() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageSubmissions = filteredSubmissions.slice(startIndex, endIndex);

      if (pageSubmissions.length === 0) {
        submissionsTableBody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-inbox"></i><br>
              No submissions found matching your criteria.
            </td>
          </tr>
        `;
        pagination.style.display = 'none';
        return;
      }

      submissionsTableBody.innerHTML = pageSubmissions.map(submission => {
        const formattedDate = submission.timestamp.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        const statusClass = `status-${submission.status}`;
        const truncatedWhy = submission.whyFavorite.length > 50 
          ? submission.whyFavorite.substring(0, 50) + '...' 
          : submission.whyFavorite;

        return `
          <tr>
            <td class="photo-cell">
              ${submission.userPhotoURL ? `
                <img src="${submission.userPhotoURL}" 
                     alt="${submission.userName}" 
                     class="user-photo"
                     onclick="showImageModal('${submission.userPhotoURL}', '${submission.userName}', '${submission.userEmail}')">
                <div>
                  <button class="download-btn" onclick="downloadImage('${submission.userPhotoURL}', '${submission.userName}')">
                    <i class="fas fa-download"></i> Download
                  </button>
                </div>
              ` : '<span style="color: #999;">No photo</span>'}
            </td>
            <td><strong>${submission.userName}</strong></td>
            <td>${submission.userEmail}</td>
            <td>${submission.socialHandle || '<span style="color: #999;">None</span>'}</td>
            <td><strong>${submission.favoriteArtist}</strong></td>
            <td title="${submission.whyFavorite}">${truncatedWhy || '<span style="color: #999;">No reason provided</span>'}</td>
            <td>
              <span class="status-badge ${statusClass}">${submission.status}</span>
              <select onchange="updateStatus('${submission.id}', this.value)" style="margin-top: 5px; font-size: 11px;">
                <option value="pending" ${submission.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="approved" ${submission.status === 'approved' ? 'selected' : ''}>Approved</option>
                <option value="rejected" ${submission.status === 'rejected' ? 'selected' : ''}>Rejected</option>
              </select>
            </td>
            <td>${formattedDate}</td>
            <td>
              <button class="btn btn-primary" style="font-size: 11px; padding: 5px 8px;" 
                      onclick="createDailyGame('${submission.id}')">
                <i class="fas fa-gamepad"></i> Create Game
              </button>
            </td>
          </tr>
        `;
      }).join('');

      updatePagination();
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
      
      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }

      pagination.style.display = 'flex';
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    window.changePage = function(direction) {
      const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
      const newPage = currentPage + direction;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displaySubmissions();
      }
    };

    window.updateStatus = async function(submissionId, newStatus) {
      try {
        await updateDoc(doc(db, 'featureSubmissions', submissionId), {
          status: newStatus
        });
        
        // Update local data
        const submission = allSubmissions.find(s => s.id === submissionId);
        if (submission) {
          submission.status = newStatus;
          updateStats();
          filterSubmissions();
        }
        
        console.log('Status updated successfully');
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update status. Please try again.');
      }
    };

    window.showImageModal = function(imageUrl, userName, userEmail) {
      modalImage.src = imageUrl;
      modalDetails.innerHTML = `
        <h3>${userName}</h3>
        <p><strong>Email:</strong> ${userEmail}</p>
        <button class="btn btn-primary" onclick="downloadImage('${imageUrl}', '${userName}')">
          <i class="fas fa-download"></i> Download Image
        </button>
      `;
      modal.style.display = 'block';
    };

    window.downloadImage = async function(imageUrl, fileName) {
      try {
        // Try to download using a different method
        const a = document.createElement('a');
        a.href = imageUrl;
        a.download = `${fileName.replace(/[^a-z0-9]/gi, '_')}_photo.jpg`;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Fallback: open in new tab if download fails
        setTimeout(() => {
          window.open(imageUrl, '_blank');
        }, 1000);
      } catch (error) {
        console.error('Error downloading image:', error);
        // Fallback: open in new tab
        window.open(imageUrl, '_blank');
      }
    };

    window.createDailyGame = function(submissionId) {
      const submission = allSubmissions.find(s => s.id === submissionId);
      if (submission) {
        alert(`Create daily game for ${submission.userName} featuring ${submission.favoriteArtist}\n\nThis would typically open a game creation interface or redirect to the daily game editor.`);
      }
    };

    function exportToCSV() {
      if (filteredSubmissions.length === 0) {
        alert('No data to export');
        return;
      }

      const headers = ['Name', 'Email', 'Social Handle', 'Favorite Artist', 'Why Favorite', 'Status', 'Date', 'Photo URL'];
      const csvContent = [
        headers.join(','),
        ...filteredSubmissions.map(submission => [
          `"${submission.userName}"`,
          `"${submission.userEmail}"`,
          `"${submission.socialHandle}"`,
          `"${submission.favoriteArtist}"`,
          `"${submission.whyFavorite.replace(/"/g, '""')}"`,
          `"${submission.status}"`,
          `"${submission.timestamp.toISOString()}"`,
          `"${submission.userPhotoURL}"`
        ].join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `feature_submissions_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function showLoading() {
      submissionsTableBody.innerHTML = `
        <tr>
          <td colspan="9" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading feature submissions...</p>
          </td>
        </tr>
      `;
    }

    function showError(message) {
      submissionsTableBody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">
            <i class="fas fa-exclamation-triangle"></i><br>
            ${message}
          </td>
        </tr>
      `;
    }
  </script>
</body>
</html> 