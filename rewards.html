<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Rewards | Guess The Singer</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(to bottom, #f9fbfd, #d6eaf8);
      padding-bottom: 90px;
    }

    /* Header (logo) */
    .header {
      background: linear-gradient(135deg, #3b7bbf, #234d7d);
      padding: 40px 20px;
      text-align: center;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .header .logo img {
      width: 200px;
      height: auto;
      margin: 0 auto;
      display: block;
    }
    @media (max-width: 768px) {
      .header .logo img {
        width: 60%;
        padding: 0;
      }
      .header {
        height: 35px;
      }
    }

    /* Top nav (match daily game / feedback) */
    nav.top-nav {
      background-color: #1e2b38;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      width: 100%;
      box-sizing: border-box;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .welcome-nav {
      position: relative;
    }

    .welcome-msg {
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 32px;
      left: 0;
      background-color: #1e2b38;
      padding: 10px;
      border-radius: 10px;
      flex-direction: column;
      min-width: 160px;
      z-index: 10;
    }

    .dropdown.show {
      display: flex;
    }

    .dropdown a {
      color: white;
      text-decoration: none;
      padding: 8px 12px;
      font-weight: 500;
      font-size: 0.9rem;
      border-radius: 6px;
    }

    .dropdown a:hover {
      background-color: #ffcb05;
      color: #1e2b38;
    }

    #coinWrapper {
      display:flex;
      align-items:center;
      gap:6px;
      font-size: 0.95rem;
    }

    /* Coin styles (shared) */
    .coin-emoji {
      width: 15px;
      height: 15px;
      background: radial-gradient(circle at 30% 30%, #ffd700, #f1c40f);
      border-radius: 50%;
      margin-bottom: 3px;
      box-shadow:
        0 1px 0 #cfa300,
        0 2px 0 #b8860b,
        0 3px 0 #8c6e00;
      position: relative;
    }

    .coin-emoji::after {
      content: "";
      position: absolute;
      top: 1px;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 30% 30%, #ffe066, transparent);
      border-radius: 50%;
      z-index: 1;
    }

    .coin-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffd700, #f1c40f);
      box-shadow:
        0 1px 0 #cfa300,
        0 2px 0 #b8860b;
    }

    /* Rewards grid / cards */
    .reward-section {
      padding: 20px;
    }

    .reward-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      justify-items: center;
      padding: 16px;
    }

    @media (min-width: 769px) {
      .reward-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    .shop-style {
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 12px;
      width: 100%;
      max-width: 160px;
      border: 2px solid #ccc;
      border-radius: 15px;
      background: #fdfdfd;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: transform 0.2s ease;
    }

    .shop-style:hover {
      transform: scale(1.03);
    }

    .reward-image-top {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 12px;
    }

    .center-text {
      font-size: 14px;
      margin-bottom: 6px;
      color: #333;
    }

    .reward-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 6px;
      color: #1e2b38;
    }

    .reward-desc {
      color: #555;
      font-size: 14px;
    }

    .price-tag {
      background: linear-gradient(to right, #f1c40f, #f39c12);
      color: #1e2b38;
      font-weight: bold;
      border-radius: 12px;
      padding: 6px 14px;
      font-size: 16px;
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
    }

    .highlight {
      color: #ffcb05;
    }

    .highlight i {
      color: #ffcb05;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 20px;
      padding: 30px 25px;
      text-align: center;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      animation: popIn 0.3s ease-out;
    }

    .modal-content h2 {
      margin-top: 0;
      color: #1e2b38;
      font-size: 22px;
    }

    #redeemText {
      font-size: 16px;
      color: #444;
      margin: 15px 0 25px;
      line-height: 1.5;
    }

    .modal-content button {
      font-family: 'Fredoka', sans-serif;
      font-weight: bold;
      padding: 10px 18px;
      border-radius: 50px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    #confirmRedeem {
      background-color: #28a745;
      color: white;
      margin-right: 10px;
    }

    #confirmRedeem:hover {
      background-color: #218838;
    }

    #cancelRedeem {
      background-color: #f44336;
      color: white;
    }

    #cancelRedeem:hover {
      background-color: #c0392b;
    }

    @keyframes popIn {
      from {
        transform: scale(0.95);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .hidden {
      display: none;
    }

    /* Locked state */
    .reward-card.locked {
      filter: grayscale(1) brightness(0.85);
      opacity: 0.7;
      position: relative;
      pointer-events: none;
    }

    .locked-overlay {
      position: absolute;
      left: 0; right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.92);
      border-radius: 0 0 12px 12px;
      padding: 8px 0;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #1e2b38;
      z-index: 2;
      font-size: 1.05rem;
      box-shadow: 0 -2px 8px rgba(30,47,90,0.08);
      width: 100%;
      gap: 8px;
    }

    .locked-overlay i {
      font-size: 1.2rem;
      margin-bottom: 0;
      color: #b8860b;
    }

    .price-tag.locked {
      filter: grayscale(1) brightness(0.85);
      opacity: 0.7;
    }

    /* Dropdowns */
    #stickerSelect,
    #raffleSelect {
      width: 100%;
      box-sizing: border-box;
      margin: 10px 0 10px 0;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 16px;
      background: #f7fafc;
      border: 1.5px solid #cfd8dc;
      outline: none;
      display: block;
    }

    /* Alert bar */
    .alert-bar {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #1e2b38;
      color: #fff;
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-weight: bold;
      z-index: 2000;
      font-size: 14px;
      animation: fadeSlideUp 0.3s ease;
    }

    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* Bottom nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #1e2b38;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .bottom-nav .nav-item {
      color: white;
      text-align: center;
      text-decoration: none;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .bottom-nav .nav-item i,
    .bottom-nav .nav-item img {
      display: block;
      font-size: 20px;
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .bottom-nav .nav-item:hover {
      color: #ffcb05;
    }

    .bottom-nav .highlight {
      color: #ffcb05;
    }

    /* Selected card outline */
    .selected-reward-card {
      outline: 3px solid #4682b4;
      box-shadow: 0 0 0 4px #b3d1ee;
      z-index: 2;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <a href="/index.html">
        <img src="images/SingerLogo.png" alt="Guess the Singer Logo" loading="lazy">
      </a>
    </div>
  </header>

  <!-- Top Nav (matches daily/feedback pages) -->
  <nav class="top-nav">
    <div class="nav-left">
      <div class="welcome-nav">
        <div id="welcomeMessage" class="welcome-msg">Welcome, Anonymous</div>
        <div id="dropdownMenu" class="dropdown"></div>
      </div>
      <div id="coinWrapper">
        <div class="coin-emoji"></div>
        <span id="coinCount" style="font-weight:bold;">0</span>
      </div>
    </div>
    <div style="font-size:0.85rem; opacity:0.85;">
      Rewards Shop
    </div>
  </nav>

  <!-- Rewards Grid -->
  <div class="reward-grid">
    <!-- Sticker Reward Card -->
    <div class="reward-card shop-style" data-title="Sticker" data-cost="100" id="sticker-reward">
      <img id="stickerImage" src="images/avatars/penguindecal.png" alt="Sticker" class="reward-image-top">
      <div class="reward-title center-text" id="stickerTitle">Pop-Star Penguin Sticker</div>
      <div class="reward-desc center-text">2'' die-cut sticker</div>
      <select id="stickerSelect">
        <option value="penguindecal.png" data-title="Pop-Star Penguin Sticker" data-cost="100">Pop-Star Penguin</option>
        <option value="discodecal.png" data-title="Disco Dolphin Sticker" data-cost="100">Disco Dolphin</option>
        <option value="dumpling.png" data-title="Dancing Dumpling Sticker" data-cost="250">Dancing Dumpling</option>
        <option value="MusicalMatcha.png" data-title="Musical Matcha Sticker" data-cost="250">Musical Matcha</option>
        <option value="jazzyjaguar.png" data-title="Jazzy Jaguar Sticker" data-cost="250">Jazzy Jaguar</option>
        <option value="timmysticker.png" data-title="SoupTimmy Sticker" data-cost="250">SoupTimmy</option>
      </select>
      <div class="price-tag" id="stickerPrice">
        <span class="coin-icon"></span> 100
      </div>
    </div>

    <!-- Charitable Donation -->
    <div class="reward-card shop-style" data-title="Charitable Donation" data-cost="400">
      <img src="images/donatingdove.png" alt="Charitable Donation" class="reward-image-top">
      <div class="reward-title center-text">Charitable Donation</div>
      <div class="reward-desc center-text">Donate $1 to St. Jude or Make-A-Wish!</div>
      <div class="price-tag">
        <span class="coin-icon"></span>
        400
      </div>
    </div>

    <!-- Spotify Premium Raffle -->
    <div class="reward-card shop-style" data-title="Spotify Premium" data-cost="100" id="raffle-reward">
      <img src="images/premium.jpg" alt="Raffle Entry" class="reward-image-top">
      <div class="reward-title center-text" id="raffleTitle">Spotify Premium</div>
      <div class="reward-desc center-text">Entry into raffle for a 1-Year Spotify Premium Subscription!</div>
      <select id="raffleSelect">
        <option value="1" data-title="1 Raffle Entry" data-cost="100">1 Entry (100 coins)</option>
        <option value="5" data-title="5 Raffle Entries" data-cost="400">5 Entries (400 coins)</option>
        <option value="10" data-title="10 Raffle Entries" data-cost="700">10 Entries (700 coins)</option>
        <option value="20" data-title="20 Raffle Entries" data-cost="1200">20 Entries (1200 coins)</option>
        <option value="50" data-title="50 Raffle Entries" data-cost="2500">50 Entries (2500 coins)</option>
      </select>
      <div class="price-tag" id="rafflePrice">
        <span class="coin-icon"></span> 100
      </div>
    </div>

    <!-- AirPods Max Raffle (kept as-is structurally) -->
    <div class="reward-card shop-style" data-title="AirPods Max" data-cost="500">
      <img src="images/AIRPODSMAX.jpg" alt="AirPods Entry" class="reward-image-top">
      <div class="reward-title center-text">AirPods Max</div>
      <div class="reward-desc center-text">Entry into raffle to win AirPods Max!</div>
      <select style="margin: 10px auto 10px auto; display: block; padding: 8px 12px; border-radius: 10px; font-size: 16px;">
        <option value="1">1 Entry (500 coins)</option>
        <option value="5">5 Entries (2000 coins)</option>
        <option value="10">10 Entries (3500 coins)</option>
        <option value="20">20 Entries (6000 coins)</option>
        <option value="50">50 Entries (12000 coins)</option>
      </select>
      <div class="price-tag">
        <span class="coin-icon"></span> 500
      </div>
    </div>

    <!-- Double Coins -->
    <div class="reward-card shop-style" data-title="Double Coins" data-cost="300" id="double-coins-reward">
      <img src="images/doublecoins.png" alt="Double Coins" class="reward-image-top">
      <div class="reward-title center-text">Double Coins</div>
      <div class="reward-desc center-text">Earn double coins on all games for the next 24 hours!</div>
      <div class="price-tag">
        <span class="coin-icon"></span>
        300
      </div>
    </div>

    <!-- Call with Colby -->
    <div class="reward-card shop-style" data-title="Call with Colby" data-cost="5000">
      <img src="images/avatars/colbypfp.jpeg" alt="Colby Martel" class="reward-image-top">
      <div class="reward-title center-text">Call with Colby</div>
      <div class="reward-desc center-text">I will guess your favorite singer on a live call!</div>
      <div class="price-tag">
        <span class="coin-icon"></span>
        5000
      </div>
    </div>
  </div>

  <!-- Redeem Modal -->
  <div id="redeemModal" class="modal hidden">
    <div class="modal-content">
      <h2>Confirm Redemption</h2>
      <p id="redeemText">Are you sure you want to redeem this reward?</p>
      <select id="charitySelect" class="hidden" style="margin-bottom: 20px; padding: 8px 12px; border-radius: 10px; font-size: 16px;">
        <option value="St. Jude">St. Jude</option>
        <option value="Make-A-Wish">Make-A-Wish</option>
      </select>      
      <div style="margin-top: 20px;">
        <button id="confirmRedeem" style="margin-right: 10px;">Redeem</button>
        <button id="cancelRedeem">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Bottom Nav -->
  <footer class="bottom-nav">
    <a href="/profile.html" class="nav-item">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
    <a href="/games.html" class="nav-item">
      <i class="fas fa-gamepad"></i>
      <span>Games</span>
    </a>       
    <a href="/memory-leaderboard.html" class="nav-item">
      <i class="fas fa-trophy"></i>
      <span>Leaderboards</span>
    </a>
    <a href="/rewards.html" class="nav-item highlight">
      <i class="fas fa-gift"></i>
      <span>Rewards</span>
    </a>
    <div id="alertBar" class="alert-bar hidden"></div>
  </footer>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      increment,
      addDoc,
      collection,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyD36qSJ8YAPc3A4FL9jlBGlpiWwj530SPQ",
      authDomain: "guessthesinger10.firebaseapp.com",
      projectId: "guessthesinger10",
      storageBucket: "guessthesinger10.appspot.com",
      messagingSenderId: "97201023235",
      appId: "1:97201023235:web:ab111d9acb43ef7d4be136"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM elements for nav
    const welcomeEl    = document.getElementById("welcomeMessage");
    const dropdownMenu = document.getElementById("dropdownMenu");
    const coinDisplay  = document.getElementById("coinCount");

    let currentUserCoins = 0;

    function setAnonymousUI() {
      if (welcomeEl) welcomeEl.textContent = "Welcome, Anonymous";
      if (coinDisplay) coinDisplay.textContent = "0";
      if (dropdownMenu) {
        dropdownMenu.innerHTML = `
          <a href="/login.html" id="loginLinkDropdown">Log In</a>
          <a href="/signup.html">Create Profile</a>
        `;
        // add redirect to login so user returns to rewards page
        const loginLink = document.getElementById('loginLinkDropdown');
        if (loginLink) {
          const currentUrl = window.location.pathname + window.location.search;
          loginLink.href = `/login.html?redirect=${encodeURIComponent(currentUrl)}`;
        }
      }
    }

    function updateLockedRewards(userCoins) {
      document.querySelectorAll('.reward-card').forEach(card => {
        const price = parseInt(card.dataset.cost);
        if (isNaN(price)) return;
        let overlay = card.querySelector('.locked-overlay');
        const priceTag = card.querySelector('.price-tag');

        if (userCoins < price) {
          card.classList.add('locked');
          if (priceTag) {
            priceTag.classList.add('locked');
            const icon = priceTag.querySelector('.coin-icon, .fa-lock');
            if (!icon || !icon.classList.contains('fa-lock')) {
              if (icon) icon.outerHTML = "<i class='fas fa-lock'></i>";
            }
          }
          if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'locked-overlay';
            overlay.innerHTML = `<span style='font-size:0.98em;'></span>`;
            card.appendChild(overlay);
          }
          overlay.querySelector('span').textContent = `Need ${price - userCoins} more coins`;
          overlay.style.display = 'flex';
        } else {
          card.classList.remove('locked');
          if (priceTag) {
            priceTag.classList.remove('locked');
            const icon = priceTag.querySelector('.fa-lock');
            if (icon) icon.outerHTML = "<span class='coin-icon'></span>";
          }
          if (overlay) overlay.style.display = 'none';
        }
      });
    }

    // Auth state listener (nav + coins + locking)
    onAuthStateChanged(auth, async (user) => {
      if (!dropdownMenu || !welcomeEl || !coinDisplay) return;

      dropdownMenu.innerHTML = "";

      if (!user) {
        currentUserCoins = 0;
        setAnonymousUI();
        updateLockedRewards(0);
        return;
      }

      let displayName = user.displayName || "Player";
      let coins = 0;

      try {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.username) displayName = data.username;
          if (typeof data.coins === "number") coins = data.coins;
        }
      } catch (err) {
        console.error("Error fetching user doc:", err);
      }

      currentUserCoins = coins;

      welcomeEl.textContent    = `Welcome, ${displayName}`;
      coinDisplay.textContent  = coins.toString();
      updateLockedRewards(coins);

      dropdownMenu.innerHTML = `
        <a href="/profile.html">Profile</a>
        <a href="#" id="logoutBtn">Log Out</a>
      `;

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          try {
            await auth.signOut();
            setAnonymousUI();
            updateLockedRewards(0);
          } catch (err) {
            console.error("Logout failed:", err);
          }
        });
      }
    });

    // Dropdown toggle
    if (welcomeEl && dropdownMenu) {
      welcomeEl.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (!dropdownMenu.contains(e.target) && e.target !== welcomeEl) {
          dropdownMenu.classList.remove("show");
        }
      });
    }

    // --------- Reward redemption logic ---------
    let selectedReward = null;

    function showAlert(message, color = "#1e2b38") {
      const alertBar = document.getElementById("alertBar");
      if (!alertBar) return;
      alertBar.textContent = message;
      alertBar.style.backgroundColor = color;
      alertBar.classList.remove("hidden");

      setTimeout(() => {
        alertBar.classList.add("hidden");
      }, 3000);
    }

    // Price-tag click handlers (generic)
    document.querySelectorAll('.price-tag').forEach(priceTag => {
      priceTag.addEventListener('click', function(e) {
        e.stopPropagation();
        const card = priceTag.closest('.reward-card');
        if (!card || card.classList.contains('locked')) return;

        // Sticker reward
        if (card.id === 'sticker-reward') {
          const stickerSelect = document.getElementById('stickerSelect');
          const selected = stickerSelect.options[stickerSelect.selectedIndex];
          selectedReward = {
            title: selected.getAttribute('data-title'),
            coinCost: parseInt(selected.getAttribute('data-cost')),
            image: selected.value
          };
          document.getElementById('charitySelect').classList.add('hidden');
          document.getElementById('redeemText').textContent =
            `Redeem "${selectedReward.title}" for ${selectedReward.coinCost} coins?`;
          document.getElementById('redeemModal').classList.remove('hidden');
          return;
        }

        // Charitable Donation: show charity selector
        if (card.dataset.title === 'Charitable Donation') {
          document.getElementById('charitySelect').classList.remove('hidden');
        } else {
          document.getElementById('charitySelect').classList.add('hidden');
        }

        selectedReward = {
          title: card.dataset.title,
          coinCost: parseInt(card.dataset.cost)
        };
        document.getElementById('redeemText').textContent =
          `Redeem "${selectedReward.title}" for ${selectedReward.coinCost} coins?`;
        document.getElementById('redeemModal').classList.remove('hidden');
      });
    });

    document.getElementById('cancelRedeem').addEventListener('click', () => {
      document.getElementById('redeemModal').classList.add('hidden');
      document.getElementById('charitySelect').classList.add('hidden');
    });

    document.getElementById('confirmRedeem').addEventListener('click', async () => {
      if (!auth.currentUser || !selectedReward) {
        showAlert("‚ö†Ô∏è Please log in to redeem.", "#f39c12");
        return;
      }
      const userRef = doc(db, "users", auth.currentUser.uid);
      const userSnap = await getDoc(userRef);
      const currentCoins = userSnap.exists() ? (userSnap.data().coins || 0) : 0;
      if (currentCoins < selectedReward.coinCost) {
        showAlert("‚ö†Ô∏è Not enough coins to redeem.", "#c0392b");
        document.getElementById('redeemModal').classList.add('hidden');
        document.getElementById('charitySelect').classList.add('hidden');
        return;
      }

      let charity = null;
      if (selectedReward.title === 'Charitable Donation') {
        charity = document.getElementById('charitySelect').value;
      }

      // Double Coins special case
      if (selectedReward.title && selectedReward.title.includes('Double Coins')) {
        const userData = userSnap.data();
        if (userData.doubleCoinsUntil && Date.now() < userData.doubleCoinsUntil) {
          const remainingTime = Math.ceil((userData.doubleCoinsUntil - Date.now()) / (1000 * 60 * 60));
          showAlert(`‚ö†Ô∏è Double Coins already active! ${remainingTime} hours remaining.`, "#f39c12");
          document.getElementById('redeemModal').classList.add('hidden');
          document.getElementById('charitySelect').classList.add('hidden');
          return;
        }

        const now = Date.now();
        const doubleUntil = now + 24 * 60 * 60 * 1000;
        await updateDoc(userRef, {
          coins: increment(-300),
          doubleCoinsUntil: doubleUntil
        });
        await addDoc(collection(db, "redemptions"), {
          uid: auth.currentUser.uid,
          reward: selectedReward.title,
          cost: 300,
          timestamp: serverTimestamp(),
          email: auth.currentUser.email || "N/A"
        });

        const newCoins = currentCoins - 300;
        coinDisplay.textContent = newCoins.toString();
        updateLockedRewards(newCoins);
        showAlert("‚ö° Double Coins activated for 24 hours!", "#28a745");
        document.getElementById('redeemModal').classList.add('hidden');
        document.getElementById('charitySelect').classList.add('hidden');
        return;
      }

      // Normal reward flow
      await updateDoc(userRef, {
        coins: increment(-selectedReward.coinCost)
      });
      await addDoc(collection(db, "redemptions"), {
        uid: auth.currentUser.uid,
        reward: selectedReward.title,
        cost: selectedReward.coinCost,
        timestamp: serverTimestamp(),
        email: auth.currentUser.email || "N/A",
        charity: charity
      });

      const newCoins = currentCoins - selectedReward.coinCost;
      coinDisplay.textContent = newCoins.toString();
      updateLockedRewards(newCoins);

      showAlert(`üéâ Redeemed: ${selectedReward.title}${charity ? ` to ${charity}` : ''}!`, "#28a745");
      document.getElementById('redeemModal').classList.add('hidden');
      document.getElementById('charitySelect').classList.add('hidden');
    });

    // Double Coins card click (alternative trigger)
    const doubleCoinsReward = document.getElementById('double-coins-reward');
    if (doubleCoinsReward) {
      doubleCoinsReward.addEventListener('click', () => {
        selectedReward = { title: 'Double Coins (24 Hours)', coinCost: 300 };
        document.getElementById('charitySelect').classList.add('hidden');
        document.getElementById('redeemText').textContent =
          `Redeem "Double Coins (24 Hours)" for 300 coins?`;
        document.getElementById('redeemModal').classList.remove('hidden');
      });
    }

    // Sticker dropdown logic
    const stickerSelect = document.getElementById('stickerSelect');
    if (stickerSelect) {
      const stickerImage = document.getElementById('stickerImage');
      const stickerTitle = document.getElementById('stickerTitle');
      const stickerPrice = document.getElementById('stickerPrice');
      let currentSticker = {
        title: stickerSelect.options[stickerSelect.selectedIndex].getAttribute('data-title'),
        cost: parseInt(stickerSelect.options[stickerSelect.selectedIndex].getAttribute('data-cost')),
        image: stickerSelect.value
      };
      stickerSelect.addEventListener('change', function() {
        const selected = stickerSelect.options[stickerSelect.selectedIndex];
        stickerImage.src = 'images/avatars/' + selected.value;
        stickerTitle.textContent = selected.getAttribute('data-title');
        stickerPrice.innerHTML = `<span class='coin-icon'></span> ${selected.getAttribute('data-cost')}`;
        currentSticker = {
          title: selected.getAttribute('data-title'),
          cost: parseInt(selected.getAttribute('data-cost')),
          image: selected.value
        };
      });
      // Only open redeem modal if price tag is clicked
      stickerPrice.addEventListener('click', function(e) {
        e.stopPropagation();
        selectedReward = { title: currentSticker.title, coinCost: currentSticker.cost, image: currentSticker.image };
        document.getElementById('charitySelect').classList.add('hidden');
        document.getElementById('redeemText').textContent =
          `Redeem "${currentSticker.title}" for ${currentSticker.cost} coins?`;
        document.getElementById('redeemModal').classList.remove('hidden');
      });
    }

    // Raffle dropdown logic (Spotify)
    const raffleSelect = document.getElementById('raffleSelect');
    if (raffleSelect) {
      const raffleTitle = document.getElementById('raffleTitle');
      const rafflePrice = document.getElementById('rafflePrice');
      let currentRaffle = {
        title: raffleSelect.options[raffleSelect.selectedIndex].getAttribute('data-title'),
        cost: parseInt(raffleSelect.options[raffleSelect.selectedIndex].getAttribute('data-cost')),
        entries: parseInt(raffleSelect.value)
      };
      raffleSelect.addEventListener('change', function() {
        const selected = raffleSelect.options[raffleSelect.selectedIndex];
        raffleTitle.textContent = selected.getAttribute('data-title');
        rafflePrice.innerHTML = `<span class='coin-icon'></span> ${selected.getAttribute('data-cost')}`;
        currentRaffle = {
          title: selected.getAttribute('data-title'),
          cost: parseInt(selected.getAttribute('data-cost')),
          entries: parseInt(selected.value)
        };
      });
      rafflePrice.addEventListener('click', function(e) {
        e.stopPropagation();
        selectedReward = { title: currentRaffle.title, coinCost: currentRaffle.cost, entries: currentRaffle.entries };
        document.getElementById('charitySelect').classList.add('hidden');
        document.getElementById('redeemText').textContent =
          `Redeem "${currentRaffle.title}" for ${currentRaffle.cost} coins?`;
        document.getElementById('redeemModal').classList.remove('hidden');
      });
    }
  </script>
</body>
</html>
